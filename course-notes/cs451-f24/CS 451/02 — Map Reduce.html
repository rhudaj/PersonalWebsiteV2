<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>02 — Map Reduce</title><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/></head><body><article id="8f710980-f676-4253-a286-111320d22eae" class="page sans"><header><div class="page-header-icon undefined"><img class="icon" src="https://www.notion.so/icons/folder_purple.svg"/></div><h1 class="page-title">02 — Map Reduce</h1><p class="page-description"></p></header><div class="page-body"><div id="10b2e7d3-01e5-805f-b072-cf2efdc91e09" class="column-list"><div id="8ff40f24-5cad-4d5b-b47c-9adda8c27776" style="width:50%" class="column"><p id="9042a491-13ff-4c55-a236-b3d2f76ee1f4" class=""><strong>Vertical Scaling</strong></p><p id="10b2e7d3-01e5-80d3-9c95-d93d26267fee" class="">improving single computer’s performance </p><p id="10b2e7d3-01e5-80c7-9794-f6f5d47e239c" class=""><em>e.g, add more hard-drives</em></p><p id="10b2e7d3-01e5-8007-b624-eacecc80fc48" class=""><strong>con: </strong>expensive $$$</p><p id="10b2e7d3-01e5-8015-9133-d467a312cbe9" class="">
</p></div><div id="d715733a-5b16-45fc-ba6a-58d4270fb278" style="width:50%" class="column"><p id="18291c33-27c8-4d89-bfc3-920ea045ddb2" class=""><strong>Horizontal Scaling</strong></p><p id="d415bb7e-dd97-49ab-9844-69e21d09bc37" class="">split problem across multiple computers</p><p id="10b2e7d3-01e5-80dd-812b-fb8a7011ad37" class=""><strong>pro: </strong>takes advantage of parallel processing (split up text, count separately, add together…) </p><p id="10b2e7d3-01e5-8056-91ff-f5854e73e2d3" class=""><strong>con: </strong>overhead; for talking together. Best for independent tasks. </p><p id="38d0b13c-e730-4cfb-9e93-06f13cdf99b8" class=""><strong>con: </strong>1 computer could be the bottleneck.</p></div></div><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-80b5-8097-e23f57b5a818"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_purple.svg"/></div><div style="width:100%"><p id="efb0d0e2-117a-49af-b6d0-ee1506f44a1a" class=""><strong>Ex — Word Count</strong></p><hr id="10b2e7d3-01e5-80cd-a85c-e7d5c69f9cb6"/><p id="ed70099f-01fb-4df5-8b37-e936b5197f3b" class="">How many times does the word “Waterloo” appear in text? </p><hr id="10b2e7d3-01e5-8057-a5fb-f42e1d5b1ab5"/><p id="10b2e7d3-01e5-8060-865e-d5eab1f39b0c" class="">Using <em>Horizontal Scaling</em>: </p><ol type="1" id="c7150705-87c1-4720-aaa2-6088a70207cf" class="numbered-list" start="1"><li>Each server loads 1/100th of the file </li></ol><ol type="1" id="60543a79-5726-44e4-b20e-0e6155b4d094" class="numbered-list" start="2"><li>Each server counts “waterloo”</li></ol><ol type="1" id="654f681f-7083-46bc-9d65-9ad284244006" class="numbered-list" start="3"><li>Add the 100 totals together. </li></ol></div></figure><h1 id="f6f8b112-f0d0-4d36-b448-eb57fe57b00a" class="">MapReduce</h1><h2 id="10b2e7d3-01e5-8084-a4b0-c44d1a872b6b" class="">Overview</h2><p id="616ab8dc-db1e-4445-a483-217054ac18d6" class="">MapReduce is a programming model designed for processing large datasets in a distributed environment. It revolves around two main functions:</p><ol type="1" id="10b2e7d3-01e5-8034-a92e-df948598930e" class="numbered-list" start="1"><li><strong>Map</strong></li></ol><ol type="1" id="10b2e7d3-01e5-80fe-b104-d3b386f6d06e" class="numbered-list" start="2"><li><strong>Reduce</strong></li></ol><p id="92c392a4-8c6d-4237-8c78-d5266d7914ec" class="">Both functions operate on <em><strong>key-value pairs</strong></em>, which are the basic data structure in MapReduce. The input and output for both functions are always key-value pairs.</p><h2 id="55819c24-bace-48e9-b0c7-4133b6e5d287" class=""><mark class="highlight-red"><mark class="highlight-purple_background"><code>Map</code></mark></mark></h2><p id="10b2e7d3-01e5-80c1-8912-d5bd40785843" class=""><strong>Signature:</strong><div class="indented"><p id="10b2e7d3-01e5-809f-b56b-f768be4cc51f" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mo>→</mo><mi>L</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">(key, value) → List[(key, value)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">[(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mclose">)]</span></span></span></span></span><span>﻿</span></span></p></div></p><p id="10b2e7d3-01e5-80f1-9dd7-c3f172939639" class=""><strong>Purpose:</strong><div class="indented"><p id="10b2e7d3-01e5-80cc-b1b2-cad2e15e6e52" class="">The <code>Map</code> function processes input key-value pairs and outputs a list of key-value pairs. The key point here is that it outputs a single <em>list </em>of key value pairs. </p></div></p><p id="10b2e7d3-01e5-80e0-9ef8-e6aae151c7b1" class=""><strong>Process:</strong><div class="indented"><p id="7bdc4ba2-c179-482c-8c05-c2bc64960733" class="">You can think of <code>Map</code> as a way to classify or group the data by &quot;extracting&quot; or &quot;finding&quot; relevant keys from the input. It processes each input record individually and produces 0+ output records.</p></div></p><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-8057-93b4-d27f325b6731"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_purple.svg"/></div><div style="width:100%"><p id="b76dd92e-cd67-499d-9f7e-bfd323e65e55" class=""><strong>Ex — Word Count (Map phase)</strong></p><hr id="10b2e7d3-01e5-80bf-9a28-fe24dda488b1"/><p id="10b2e7d3-01e5-8090-bed0-e58397dfaef6" class="">In a word count problem, each input record might be a line of text from a document, where:</p><ul id="10b2e7d3-01e5-801d-86bd-c0319fe30378" class="bulleted-list"><li style="list-style-type:disc">The input is: <code>(position in file: int, line of text: string)</code></li></ul><ul id="e3256502-cd26-4a12-8e00-780ab7bb49f9" class="bulleted-list"><li style="list-style-type:disc">The map function will take this line of text and split it into words.</li></ul><ul id="10b2e7d3-01e5-80c6-b20b-d9d902a71144" class="bulleted-list"><li style="list-style-type:disc">The output would be a list of KVPs, where the key is each word and the value is the count <code>1</code>:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-80c1-bece-db69324809f0" class="code"><code class="language-Ruby" style="white-space:pre-wrap;word-break:break-all">(pos in file: 1, &quot;Waterloo is awesome. Waterloo is.&quot;)
=&gt; [(&quot;waterloo&quot;, 2), (&quot;is&quot;, 2), (&quot;awesome&quot;, 1)]</code></pre></li></ul><p id="10b2e7d3-01e5-8080-80fa-d0281697460c" class="">This list would then be merged with the lists from other map tasks.</p></div></figure><h2 id="78b4bc87-6bc8-4e26-a9c6-02c046b62a37" class=""><mark class="highlight-red"><code>Reduce</code></mark></h2><ul id="10b2e7d3-01e5-80ef-b4c0-ee3882cdcce1" class="bulleted-list"><li style="list-style-type:disc"><strong>Function signature:</strong><p id="e2573d7f-87cf-4f26-a713-1b1a6a7860be" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>L</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">[</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>→</mo><mi>L</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">(key, List[value]) → List[(key, value)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mclose">])</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">[(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mclose">)]</span></span></span></span></span><span>﻿</span></span></p></li></ul><ul id="10b2e7d3-01e5-8023-a4f5-e9c48c943bd7" class="bulleted-list"><li style="list-style-type:disc"><strong>Purpose:</strong><p id="10b2e7d3-01e5-80c1-946c-ea02fa07abd2" class="">The <code>Reduce</code> function aggregates <em>or</em> merges the values with the same key. It takes in a key and a list of values (all values associated with that key from the <code>Map</code> phase) and returns 1+ key-value pairs. Typically, you&#x27;ll summarize or aggregate these values into a final result.</p></li></ul><ul id="10b2e7d3-01e5-80fd-8879-c6315e38a841" class="bulleted-list"><li style="list-style-type:disc"><strong>Process:</strong><p id="10b2e7d3-01e5-80da-8d0b-c30bd46ea64a" class="">The reduce function is generally used to combine or reduce the list of values associated with a specific key into a single value. However, it&#x27;s flexible, and you can output multiple key-value pairs if needed.</p></li></ul><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="53ef9493-f8fa-4e28-bc61-a736f36d5cb1"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_gray.svg"/></div><div style="width:100%"><p id="c32f7ed1-48dc-4ec4-908d-3e7bf03636fc" class=""><strong>Ex — Word Count (Reduce phase)</strong></p><hr id="a7bca046-f65f-428d-8711-95e6ead4da2d"/><p id="10b2e7d3-01e5-80bd-86cc-ea27f2f923bb" class="">After the <em>Map</em> <em>Phase</em>, you might have something like:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="51a81d5c-21b4-43b5-bbf9-3fe37c2494e3" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">Map1: (&quot;waterloo&quot;, 2)
Map2: (&quot;waterloo&quot;, 4)
Map3: (&quot;waterloo&quot;, 3)</code></pre><p id="10b2e7d3-01e5-8037-ba9c-eb71637a8f58" class="">The reduce function can be used to sum up these values:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-80c4-babc-d38b701bf18d" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">(&quot;waterloo&quot;, 7)</code></pre></div></figure><h2 id="10b2e7d3-01e5-8006-80a8-fc3d45d9fea7" class=""><strong>Why? Have 2 phases, Map &amp; Reduce</strong></h2><p id="10b2e7d3-01e5-8005-98cf-fbe93e84ea79" class="">By splitting the data processing into these 2 stages, <em>MapReduce</em> allows for large-scale distributed processing. Each <code>Map</code> task can run in parallel, and the intermediate key-value pairs from all map tasks are shuffled and grouped by key before going to the <code>Reduce</code> tasks.</p><h2 id="10b2e7d3-01e5-80d9-9f59-c7430c396628" class="">All Word Counts</h2><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="8f3b1ed9-a8f0-4383-a794-2c7dcec86391"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_gray.svg"/></div><div style="width:100%"><p id="7435bb81-9aa0-4b4b-b57b-755386e10f18" class=""><strong>Ex — All Word Counts</strong></p><hr id="7b7f0ae6-f0ff-4522-9d09-134875f6b9e4"/><p id="8e546b86-55e9-40ff-9dd9-9c8ad1b72aa1" class="">Split the file into chunks, assign each chunk to a <em>mapper</em> on a server: <div class="indented"><p id="3c26a1c2-d5ac-4f41-a2fa-db7e41bc3af9" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>text</mtext><mo>→</mo><mstyle mathcolor="#df0030"><mtext>Map</mtext></mstyle><mo>→</mo><mtext>(word, count)[]</mtext></mrow><annotation encoding="application/x-tex">\text{text} \rarr \text{\red{Map}}\rarr \text{(word, count)[]}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord text"><span class="mord">text</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord" style="color:#df0030;">Map</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(word, count)[]</span></span></span></span></span></span><span>﻿</span></span></p><p id="10b2e7d3-01e5-8077-a973-f5ec0aea8af7" class=""><mark class="highlight-yellow_background">note: count ≥ 1 </mark></p></div></p><p id="33e31ede-3f5b-4789-b868-65bfb0a6fec4" class="">All mappers send their KVP’s to a single machine which calls <code>reduce()</code> to <em>aggregate </em>the results.<div class="indented"><p id="10b2e7d3-01e5-804a-9ee7-dc334d545196" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>(word, count)[]</mtext><mo>→</mo><mstyle mathcolor="#df0030"><mtext>Reduce</mtext></mstyle><mo>→</mo><mtext>(word, count)[]</mtext></mrow><annotation encoding="application/x-tex">\text{(word, count)[]} \rarr \text{\red{Reduce}} \rarr \text{(word, count)[]}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(word, count)[]</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord" style="color:#df0030;">Reduce</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(word, count)[]</span></span></span></span></span></span><span>﻿</span></span></p></div></p><figure id="85322ae7-de09-4f12-87e0-8dab7cf12810" class="image" style="text-align:center"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-12_at_11.59.11.png"><img style="width:432px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-12_at_11.59.11.png"/></a></figure></div></figure><p id="10b2e7d3-01e5-8030-b77f-f493b83fd750" class=""><mark class="highlight-yellow_background"><strong>Problem</strong></mark><strong>: Unbounded Memory Needed for Large Vocabulary</strong><div class="indented"><ul id="10b2e7d3-01e5-801c-8299-c52011876456" class="bulleted-list"><li style="list-style-type:disc">If the mappers are counting words, they need to hold a dictionary of words that it’s seen. </li></ul><ul id="c5a0d6ca-be68-41ae-88cd-757fcb6e3562" class="bulleted-list"><li style="list-style-type:disc">The # of possible keys (words) in the vocabulary is potentially infinite. The memory required to store all these words and their counts could grow without bound.</li></ul></div></p><p id="10b2e7d3-01e5-807d-ae8d-fce834d25be3" class=""><mark class="highlight-teal_background"><strong>Solution</strong></mark><strong>: Emit Words Immediately</strong></p><ul id="10b2e7d3-01e5-8027-9a5c-ecb6eee00201" class="bulleted-list"><li style="list-style-type:disc">Instead of holding all words in memory until the entire chunk is processed, the mapper <em><code>emits</code></em> each word and its count (<code>1</code>) as soon as it sees the word in the input.</li></ul><ul id="10b2e7d3-01e5-80e8-a6cd-e5637e3cba3c" class="bulleted-list"><li style="list-style-type:disc">The words are passed on to the next stage (shuffle and reduce) as soon as they&#x27;re processed, keeping memory usage low.</li></ul><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-806d-8099-f1444d580620"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_gray.svg"/></div><div style="width:100%"><p id="b018fe00-8ec1-43a2-8352-fa895671ca04" class=""><strong>Ex — All Word Counts</strong></p><hr id="cc3f027a-8959-4372-b529-3f0ff3ffbdb4"/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1254878f-88bc-4f2c-8eec-8433f1a5951c" class="code"><code class="language-Python">def map(line):
	for word in line:
		emit(word, 1)

# reduce function does not change. Still adds to the sum.
def reduce(key, values):
	sum = 0;
	for v in values:
		sum += v
	emit(key, sum)</code></pre></div></figure><hr id="c6aa920f-838b-45a6-9a6d-024bfd6abd1b"/><p id="4c26d5b5-cf44-49aa-a1d9-04f2ebf92646" class=""><strong>New Problem: Single Reducer Bottleneck</strong></p><ul id="10b2e7d3-01e5-8083-a141-ccbcce24d147" class="bulleted-list"><li style="list-style-type:disc">Even though memory usage is reduced by emitting words immediately, all the word counts are still being aggregated on a <em>single reducer</em> machine.</li></ul><ul id="10b2e7d3-01e5-80b5-ac1d-e4cb5fcf35c4" class="bulleted-list"><li style="list-style-type:disc">The reducer is responsible for processing the entire dataset’s word count, meaning it could become a bottleneck, as it still has to process large amounts of data.</li></ul><p id="10b2e7d3-01e5-807b-9663-d4b2302c4773" class=""><strong>Solution: </strong><strong><span style="border-bottom:0.05em solid">Partition</span></strong><strong> to Multiple Reducers</strong></p><ul id="10b2e7d3-01e5-80b9-8e2a-f7aa4d5eeb89" class="bulleted-list"><li style="list-style-type:disc">Instead of using just 1 reducer, we partition the data to multiple reducers </li></ul><ul id="10b2e7d3-01e5-8078-a39f-ee4ad02a294d" class="bulleted-list"><li style="list-style-type:disc">Each reducer handles a <em>subset of the keys</em>. <ul id="10b2e7d3-01e5-8042-9523-dd3931ecd558" class="bulleted-list"><li style="list-style-type:circle">e.g., Reducer 1 handles all the words starting with letters A-M. Reducer 2 handles words starting with N-Z.</li></ul></li></ul><h2 id="10b2e7d3-01e5-804e-bd02-c0259f341102" class=""><code>Partition</code></h2><p id="10b2e7d3-01e5-805e-afaa-ca7a4040475c" class=""><strong>Function signature:</strong><div class="indented"><p id="271670db-63b3-43d5-aefc-ba816273d99c" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(key, value, n) → [0,n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span></p></div></p><p id="10b2e7d3-01e5-808d-a88e-d134d33cd5bd" class=""><strong>Purpose:</strong><div class="indented"><p id="10b2e7d3-01e5-802d-84a5-dc8ced147677" class="">Assigns key-value pair to 1 of <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span><span>﻿</span></span> reducers, based on the key. </p><ul id="10b2e7d3-01e5-80e2-82c8-cf2370312e44" class="bulleted-list"><li style="list-style-type:disc"><strong>Partitioning rule: </strong>(e.g., a hash function).</li></ul></div></p><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="15a2e7d3-01e5-8002-abb4-e4f333c7bf7c"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/exclamation-mark_gray.svg"/></div><div style="width:100%"><p id="455f3853-2eb5-459b-ab92-4c17dc4f1330" class="">If you have x reduce tasks (partitions), it doesn&#x27;t mean that you will end up calling the reduce() method x times. It will be called once for every distinct key. So 1 reduce task can call the reduce() method several times. </p></div></figure><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="15a2e7d3-01e5-80af-9ef4-fae964399698"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/exclamation-mark_gray.svg"/></div><div style="width:100%"><p id="56ec56f3-30d1-497b-b9ec-997efb732036" class=""><strong>Note</strong></p><p id="15a2e7d3-01e5-80d1-aeb0-d4e3cbe4fbaf" class=""><mark class="highlight-default_background">All KVPs with the same key go to the same reducer. </mark><mark class="highlight-default_background"><strong>This can’t be changed</strong></mark><mark class="highlight-default_background">.</mark></p><p id="15a2e7d3-01e5-80df-869c-dc39888a4eb3" class=""><mark class="highlight-default_background">We can only change what </mark><em><mark class="highlight-default_background">other</mark></em><mark class="highlight-default_background"> keys (if any) will be placed in the same partition, hence handled by the same task. </mark></p><p id="15a2e7d3-01e5-806e-a475-e8c2aa3ae834" class=""><mark class="highlight-default_background"><strong>A reduce task can call the reduce() function more than once, but only once for every key.</strong></mark></p></div></figure><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="599bb04c-6bfb-41d0-b7cc-4b74b6640eba"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_gray.svg"/></div><div style="width:100%"><p id="6cfa92fc-ac50-4059-8f6b-1ce63403c4ef" class=""><strong>Ex — All Word Counts</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8c8f5365-de30-4216-b295-13d528a46985" class="code"><code class="language-Python">def map(pos : Long, text: String):
		for word in tokenize(text):
				emit(word, 1)

def reduce(key: String, values: Collection of Ints):
		sum = 0
		for v in values:
				sum += v emit(key, sum)

def partition(key : String, reducer_count: Nat):
	return hashcode(key) % reducer_count</code></pre></div></figure><h2 id="10b2e7d3-01e5-80f2-9e4c-de8f829847d6" class="">Shuffling </h2><ul id="10b2e7d3-01e5-80f0-a363-f42213cc1da3" class="bulleted-list"><li style="list-style-type:disc"><strong>What it is:</strong><p id="10b2e7d3-01e5-80eb-b184-eb728b8fe510" class="">The process of <em>transferring</em> (or “shuffling”) the intermediate data <em>provided by the partitioner</em> to the reducers. </p></li></ul><ul id="10b2e7d3-01e5-80a9-8710-f66fe7450772" class="bulleted-list"><li style="list-style-type:disc"><strong>When it happens:</strong><p id="10b2e7d3-01e5-8037-9794-e7dadacac215" class="">After partitioning.</p><p id="10b2e7d3-01e5-8075-8c0d-f6e2ba11b25a" class="">Shuffling can start before the map phase has finished saving some time. That&#x27;s why you can see a reduce status greater than 0% (but less than 33%) when the map status is not yet 100%.</p></li></ul><ul id="e9f009b6-7d77-40c0-b00c-4554a86c3452" class="bulleted-list"><li style="list-style-type:disc"><strong>Why it&#x27;s needed:</strong><p id="10b2e7d3-01e5-8080-8de9-c4bfa83dee5a" class="">Ensures that the data is correctly grouped by key, allowing the <code>reduce()</code> function to process each key with its associated values. </p></li></ul><h2 id="10b2e7d3-01e5-80ee-ba21-d16aa1e75875" class=""><strong>Sorting</strong></h2><ul id="15a2e7d3-01e5-80f1-819b-f407aeb3acb6" class="bulleted-list"><li style="list-style-type:disc"><strong>why? </strong><ul id="15a2e7d3-01e5-8075-ac6b-c96be0e235ec" class="bulleted-list"><li style="list-style-type:circle">Reduce tasks are a list of KVPs (not necessarily all the same key). <ul id="15a2e7d3-01e5-8061-963d-c67758d59f84" class="bulleted-list"><li style="list-style-type:square">A new reduce task should be started when the next key in the <strong>sorted</strong> list is different than the previous. </li></ul></li></ul><ul id="15a2e7d3-01e5-8074-bcce-c3b0a6d6080b" class="bulleted-list"><li style="list-style-type:circle">It must call the <code>reduce()</code> method with a <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>l</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(key, list(value))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mclose">))</span></span></span></span></span><span>﻿</span></span> pair, so it has to group values by key. </li></ul><ul id="15a2e7d3-01e5-809e-81b7-f58c6bf91457" class="bulleted-list"><li style="list-style-type:circle">This is easy if the the input data is sorted by key: </li></ul></li></ul><ul id="15a2e7d3-01e5-8098-b758-dc2107d541fe" class="bulleted-list"><li style="list-style-type:disc"><strong>How? </strong><p id="15a2e7d3-01e5-8022-b239-f0b360429bcf" class="">Pre-sorted (locally) in the map phase and simply merge-sorted in the reduce phase (since the reducers get data from many mappers).</p></li></ul><ul id="15a2e7d3-01e5-8060-b264-db05e06b118e" class="bulleted-list"><li style="list-style-type:disc"><strong>Why? </strong><p id="15a2e7d3-01e5-800e-86aa-c2a1d8c25c31" class="">Saves time for the reducer, helping it easily distinguish when a new reduce task should start. </p></li></ul><h1 id="d4006e9f-89e9-469a-8181-cd0a47c37452" class="">Hadoop</h1><p id="07fda583-c234-414e-a972-2f5c35a2f95c" class="">The most popular implementation of the <em>MapReduce</em> framework, written in <strong>Java</strong>. It allows large-scale data processing across distributed machines by <strong>efficiently</strong> implementing the MapReduce paradigm.</p><h3 id="10b2e7d3-01e5-8015-80a2-e668a01ad1e8" class=""><strong>How it Works</strong></h3><figure id="10b2e7d3-01e5-80f7-b15e-da58f94ba19e" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-12_at_12.39.01.png"><img style="width:672px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-12_at_12.39.01.png"/></a></figure><ol type="1" id="87f641bd-0e6d-407c-b561-72728e98259a" class="numbered-list" start="1"><li><strong>Workers &amp; Task Assignment:</strong><ul id="10b2e7d3-01e5-80bc-9449-c314efe63654" class="bulleted-list"><li style="list-style-type:disc">Hadoop assigns <em>workers</em> (machines or nodes in the cluster) to specific tasks to either be mappers (does <code>map</code> tasks) or reducers (does <code>reduce</code> tasks). </li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-8055-b0b5-dfd1156c7744" class="numbered-list" start="2"><li><strong>Data Division (Map Phase):</strong><ul id="10b2e7d3-01e5-8038-8e1e-d296e1165de2" class="bulleted-list"><li style="list-style-type:disc">Hadoop divides the input data into smaller <strong>chunks</strong>. </li></ul><ul id="10b2e7d3-01e5-8026-ba40-e14a943f93a1" class="bulleted-list"><li style="list-style-type:disc">Each mapper takes a chunk of the input file and generates KVPs as output.</li></ul></li></ol><ol type="1" id="b0e94481-13d3-42e1-938b-ec1026a1c097" class="numbered-list" start="3"><li><strong>Grouping, Sorting, Partition</strong><ul id="10b2e7d3-01e5-8005-97d1-e9e06f63fdb8" class="bulleted-list"><li style="list-style-type:disc">Group and sort the intermediate key-value pairs.<ul id="10b2e7d3-01e5-8074-862b-d9a05b73d186" class="bulleted-list"><li style="list-style-type:circle">Key-value pairs are <strong>partitioned</strong> (default is by key)</li></ul><ul id="10b2e7d3-01e5-806a-9cb4-c6aaeb4db0f4" class="bulleted-list"><li style="list-style-type:circle">Sorts the key-value pairs by key</li></ul></li></ul><ul id="15a2e7d3-01e5-8019-9f26-d35ec20256e3" class="bulleted-list"><li style="list-style-type:disc">⇒ reducers can get all values for key(s) it needs grouped together</li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-8040-84c1-fa64703a6f3c" class="numbered-list" start="4"><li><strong>Shuffling to Reducers:</strong><ul id="735384e8-eb74-4b85-9c74-c1693a5776ad" class="bulleted-list"><li style="list-style-type:disc">The KVPs are <strong>shuffled</strong> (transferred across the network) to the appropriate <code>reduce</code> workers.</li></ul><ul id="10b2e7d3-01e5-809c-ab19-f432dc7ab0b4" class="bulleted-list"><li style="list-style-type:disc">Each reducer needs <strong>ALL</strong> values for a given key before it can start. </li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-80bb-8a63-e3640959b68a" class="numbered-list" start="5"><li><strong>Final Output (Reduce Phase):</strong><ul id="10b2e7d3-01e5-8037-933b-cf9ce4666603" class="bulleted-list"><li style="list-style-type:disc">Each reducer aggregates the values associated with the specific key and produces the final KVPs to store in <strong>HDFS</strong>. </li></ul></li></ol><hr id="7af72780-a593-408c-af46-ff52d506c3c4"/><p id="10b2e7d3-01e5-80e2-b0ab-d12404b17a01" class=""><strong>Problem: </strong><div class="indented"><p id="10b2e7d3-01e5-80ad-8950-f4edb143292d" class="">Shuffling is the <strong>slowest operation </strong>because it involves <span style="border-bottom:0.05em solid">sending data across the network</span>. </p><p id="10b2e7d3-01e5-80e7-8983-f70c00f3e7e6" class="">Since shuffling large amounts of intermediate data is slow, it makes sense to minimize the amount of data that needs to be transferred.</p></div></p><p id="10b2e7d3-01e5-80c9-9415-c5e838b7eaa6" class=""><strong>Solution: </strong>Combiner</p><h2 id="1b3c30d1-abfb-48c7-866b-7a13d1936ca6" class=""><code>Combine</code></h2><p id="917564b0-5253-4de1-ae8c-1af3339c67c7" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>k</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>L</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">[</mo><msub><mi>v</mi><mn>2</mn></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>→</mo><mi>L</mi><mi>i</mi><mi>s</mi><mi>t</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><msub><mi>k</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>v</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">(k_2,List[v_2]) \rarr List[(k_2, v_2)] </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">])</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">[(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span><span>﻿</span></span></p><ul id="10b2e7d3-01e5-80b8-90b3-cddc61a06376" class="bulleted-list"><li style="list-style-type:disc"><strong>Function Signature</strong></li></ul><ul id="10b2e7d3-01e5-8049-aadb-dcdd2aca2b67" class="bulleted-list"><li style="list-style-type:disc"><strong>Purpose: </strong><p id="10b2e7d3-01e5-8087-a8c1-e933780700bc" class="">It’s a <strong>local optimization</strong> step. It is used to reduce the number of intermediate KVPs that need to be sent from the mapper to the reducer during the shuffle phase. It helps in minimizing the amount of data transferred over the network by performing a <strong>partial reduction</strong> on the mapper node.</p></li></ul><ul id="10b2e7d3-01e5-8056-af0b-f49d74f3383f" class="bulleted-list"><li style="list-style-type:disc"><strong>When it happens:</strong><p id="6e9c8607-053c-476b-a773-94fa2be1af4f" class="">It’s called <strong>on the mapper node</strong>, before the shuffle phase</p></li></ul><ul id="10b2e7d3-01e5-8054-a623-dc15468f84e1" class="bulleted-list"><li style="list-style-type:disc"><strong>Process: </strong><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-80e4-94e2-ed02e82a08e0" class="code"><code class="language-Python">def combine(key, values):
    sum = 0
    for v in values:
        sum += v
    emit(key, sum)</code></pre></li></ul><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-80b6-b113-d127230118b6"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_gray.svg"/></div><div style="width:100%"><p id="7dba318b-c398-4ef8-a5f3-d4150d0b16b5" class=""><strong>Ex — All Word Counts</strong></p><hr id="10b2e7d3-01e5-8047-8195-d44ae0bac599"/><p id="fd81629b-bebc-4e3f-8094-cba7317c7874" class="">Without a combiner, a mapper might output:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="123291cc-6ec0-4706-992e-0d2b722c8385" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">(&quot;waterloo&quot;, 1), (&quot;waterloo&quot;, 1), (&quot;waterloo&quot;, 1)</code></pre><p id="21cc812c-0eab-4914-89bc-20641e6bdd5a" class="">After shuffling, the reducer receives:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="551bdedb-6610-4b27-afbd-07d2646ebd84" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">(&quot;waterloo&quot;, [1, 1, 1])</code></pre><p id="10054cd1-4735-4d03-8a99-33db0c59a8fc" class="">The reducer then sums these values to get:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a1c963b1-2aaa-45e6-8d18-168182f6c1b4" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">(&quot;waterloo&quot;, 3)</code></pre><p id="29e57a85-4f24-467f-9f22-66dd77a5f931" class="">With a combiner, the mapper combines the values locally and outputs:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d71adeeb-d527-4a46-9c28-39cad9e4ff40" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">(&quot;waterloo&quot;, 3)</code></pre><p id="bb7c7ffa-82a2-48a9-be97-5e41f2fa7421" class="">So, during shuffling, the reducer only receives:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="72a16970-4b2b-40c8-a300-d0bbd813d95b" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">(&quot;waterloo&quot;, 3)</code></pre></div></figure><h3 id="10b2e7d3-01e5-804c-ab5e-e8ed3ccb09bf" class=""><code>Combine</code> vs. <code>Reduce</code></h3><table id="1fa359ff-f2bb-458a-8bf2-ea6be55c8231" class="simple-table"><thead class="simple-table-header"><tr id="a8cb676c-67dc-4af3-8d3c-298be90b0701"><th id="q}=_" class="simple-table-header-color simple-table-header" style="width:318.99998474121094px"><strong>Combiner</strong></th><th id="IuSh" class="simple-table-header-color simple-table-header" style="width:332.99998474121094px"><strong>Reducer</strong></th></tr></thead><tbody><tr id="c17b9c2c-8873-42fe-a675-963c0bc2aa4c"><td id="q}=_" class="" style="width:318.99998474121094px">Local optimization (optional)</td><td id="IuSh" class="" style="width:332.99998474121094px">Final aggregation (required)</td></tr><tr id="4894755e-ffdd-41fd-a60f-80fefc935979"><td id="q}=_" class="" style="width:318.99998474121094px">Operates on a subset of values for a key</td><td id="IuSh" class="" style="width:332.99998474121094px">Operates on all values for a key</td></tr><tr id="5f9713ee-a552-4df4-a603-135a604274d3"><td id="q}=_" class="" style="width:318.99998474121094px">Reduces intermediate data before shuffling</td><td id="IuSh" class="" style="width:332.99998474121094px">Reduces final data after shuffling</td></tr><tr id="5e9c0de8-d3f7-48f0-8e63-cd2a1f8037c1"><td id="q}=_" class="" style="width:318.99998474121094px">Does not change key-value types</td><td id="IuSh" class="" style="width:332.99998474121094px">Does not change key-value types</td></tr><tr id="66e94c1c-4f47-4728-a00b-8d18329a9c4b"><td id="q}=_" class="" style="width:318.99998474121094px">Can be called by mappers to optimize</td><td id="IuSh" class="" style="width:332.99998474121094px">Always called to produce final output</td></tr></tbody></table><hr id="10b2e7d3-01e5-8015-851e-d5ab1110a0a6"/><h2 id="10b2e7d3-01e5-80bf-b1a3-ec85e4e5a21d" class="">Summary (so far)</h2><figure id="151d95fc-04d8-42f5-b8c6-dbf3db85ebf7" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-12_at_12.53.07.png"><img style="width:624px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-12_at_12.53.07.png"/></a><figcaption>The flow isn’t quite so linear. “combine” happens during map (or doesn’t happen at all) – grouping by values also happens DURING map, and then the values are shuffled to reducers to finish the grouping. The reducers can also use combine when merging intermediate files.</figcaption></figure><hr id="34ba6a17-f4cf-4677-aee0-aa32206c42b0"/><h2 id="10b2e7d3-01e5-80e3-a634-ebf39f6257d5" class="">When Combine == Mini Reduce</h2><ul id="10b2e7d3-01e5-800f-8d04-d67eca096e62" class="bulleted-list"><li style="list-style-type:disc">You can only use the same function for <code>combine</code> and <code>reduce</code> if the operation is <strong>order-independent</strong> (e.g., summing or multiplying).</li></ul><ul id="10b2e7d3-01e5-8026-a4a1-ceb5b0d4dad3" class="bulleted-list"><li style="list-style-type:disc">For operations like <strong>averaging</strong> where the <strong>order of operations matters</strong>, using the same function in the <code>combine</code> phase will likely give you the wrong result because you can’t simply combine partial results and expect to get the correct final result.</li></ul><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-80c3-bd12-cccce86c11b8"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_purple.svg"/></div><div style="width:100%"><p id="10b2e7d3-01e5-8057-91d7-f7c585e83443" class=""><strong>Ex</strong></p><hr id="10b2e7d3-01e5-80cc-afd2-fa3e715ece94"/><p id="10b2e7d3-01e5-8058-a417-fb1027a3f9a9" class="">If you are summing numbers for a word count:</p><ul id="10b2e7d3-01e5-80d0-95f5-e531d35a7d41" class="bulleted-list"><li style="list-style-type:disc">Mapper outputs: <code>(&quot;hadoop&quot;, 1)</code>, <code>(&quot;hadoop&quot;, 1)</code>, <code>(&quot;hadoop&quot;, 1)</code></li></ul><ul id="10b2e7d3-01e5-805c-81f6-d7aef2434b3d" class="bulleted-list"><li style="list-style-type:disc">Combiner can aggregate these locally on the mapper to: <code>(&quot;hadoop&quot;, 3)</code></li></ul><ul id="10b2e7d3-01e5-80e9-8ee7-d45cbaa4607b" class="bulleted-list"><li style="list-style-type:disc">The reducer can then take the final result from multiple combiners (e.g., <code>(&quot;hadoop&quot;, 3)</code> and <code>(&quot;hadoop&quot;, 5)</code>) and sum them to produce the final count: <code>(&quot;hadoop&quot;, 8)</code></li></ul><p id="10b2e7d3-01e5-80a8-8772-dd111c8a4865" class="">In this case, the <strong>combiner&#x27;s function</strong> is the same as the <strong>reducer&#x27;s function</strong> because both are summing counts and the final result will be correct regardless of the order of operations.</p></div></figure><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-804b-9fc6-f42cf2ea8132"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_purple.svg"/></div><div style="width:100%"><p id="0b7934c4-0a8a-4a4e-bef4-6b88c842ab1d" class=""><strong>Ex - Averages</strong></p><hr id="10b2e7d3-01e5-807b-bb23-cb4d2cb76f9b"/><p id="10b2e7d3-01e5-8080-98f6-e84969a54f19" class="">If you want to calculate the average of a set of numbers, you cannot simply use the reducer&#x27;s logic (which calculates the mean) as a combiner because <strong>averages don&#x27;t work that way</strong>: </p><p id="5d9eefa8-5762-4b7e-b894-d13806284283" class="">Suppose you want to calculate the average of three numbers: <code>2</code>, <code>3</code>, and <code>4</code>. The correct average is:</p><figure id="1f9a3a06-5eeb-4d84-946a-1d42a5bbeb46" class="equation"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><div class="equation-container"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>e</mi><mi>a</mi><mi>n</mi><mo stretchy="false">(</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mn>2</mn><mo>+</mo><mn>3</mn><mo>+</mo><mn>4</mn></mrow><mn>3</mn></mfrac><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">Mean(2,3,4)=\frac{2+3+4}{3}=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span><span class="mopen">(</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></span></div></figure><p id="75e44628-6acc-4680-ad6c-d98fcd35dad7" class="">Now, let’s simulate using a combiner:</p><ul id="10b2e7d3-01e5-807c-93ae-c1c413021cef" class="bulleted-list"><li style="list-style-type:disc">First, the combiner calculates the average of <code>2</code> and <code>3</code>:</li></ul><figure id="10b2e7d3-01e5-808d-9ad6-cbadffc30712" class="equation"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><div class="equation-container"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>e</mi><mi>a</mi><mi>n</mi><mo stretchy="false">(</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mn>2</mn><mo>+</mo><mn>3</mn></mrow><mn>2</mn></mfrac><mo>=</mo><mn>2.5</mn></mrow><annotation encoding="application/x-tex">Mean(2,3)=\frac{2+3}{2}=2.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span><span class="mopen">(</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2.5</span></span></span></span></span></div></figure><ul id="10b2e7d3-01e5-8008-a116-d3aea8392d63" class="bulleted-list"><li style="list-style-type:disc">Next, the combiner tries to combine this result with <code>4</code>:</li></ul><figure id="10b2e7d3-01e5-8053-9a25-c3e516d6fae0" class="equation"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><div class="equation-container"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>e</mi><mi>a</mi><mi>n</mi><mo stretchy="false">(</mo><mn>2.5</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mn>2.5</mn><mo>+</mo><mn>4</mn></mrow><mn>2</mn></mfrac><mo>=</mo><mn>3.25</mn></mrow><annotation encoding="application/x-tex">Mean(2.5,4)=\frac{2.5+4}{2}=3.25</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span><span class="mopen">(</span><span class="mord">2.5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2.5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3.25</span></span></span></span></span></div></figure><p id="c78db2ca-2ca6-40bb-9b41-a1fc070b19e9" class="">The correct average should be <code>3</code>, not <code>3.25</code>. </p><p id="10b2e7d3-01e5-8087-9a5e-e61b86732e9f" class="">You need to know both the sum and the count of the numbers, and you can&#x27;t break that process into parts.</p></div></figure><hr id="2346887e-e5fb-499f-87ea-c0475606c4bd"/><h3 id="f1c31745-385e-4ea5-8c89-566860c232e9" class=""><strong>What Hadoop is doing physically,  behind the scenes:</strong></h3><figure id="1022e7d3-01e5-8047-9c70-d1fe1b8814fc" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-15_at_17.55.44.png"><img style="width:480px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-15_at_17.55.44.png"/></a></figure><ol type="1" id="1022e7d3-01e5-80ce-b9b5-c459f342db13" class="numbered-list" start="1"><li><em><strong>Submit</strong></em><ol type="a" id="7c067d0e-7b59-47c8-b20e-27d1c450d865" class="numbered-list" start="1"><li><em>jar </em>file(s) are sent to the <em>cluster </em>to coordinate the job</li></ol></li></ol><ol type="1" id="1022e7d3-01e5-8006-947c-da2512c29023" class="numbered-list" start="2"><li><strong>Schedule mappers, Reserve Reducers</strong><ol type="a" id="1022e7d3-01e5-801f-96b8-c809b3bb4642" class="numbered-list" start="1"><li>The appropriate # of mappers is determine for the given input file. <p id="10b2e7d3-01e5-80f1-933f-fe5c348dad3e" class="">Done<strong> automatically</strong> by the framework (if not specified). </p></li></ol><ol type="a" id="10b2e7d3-01e5-80f4-8c24-dae6f490228f" class="numbered-list" start="2"><li>The specified # reducers is reserved. <p id="a6925412-9026-4c12-98bb-9ae5c0bca55a" class="">Done <strong>manually </strong>(by users), because framework can’t estimate the # of intermediate keys. </p></li></ol></li></ol><ol type="1" id="1022e7d3-01e5-8044-bb7b-fed21c7993e8" class="numbered-list" start="3"><li><strong>Read</strong><p id="1022e7d3-01e5-8044-a2be-f156f2015739" class="">Each<em> map worker</em> reads a chunk. Usually a <strong>local read </strong>- they’re only given the chunk they need. Otherwise, they do a <strong>remote read - </strong>asking a remote computer for the chunk they need.</p></li></ol><ol type="1" id="1022e7d3-01e5-8012-9e78-f0ff3ac0b045" class="numbered-list" start="4"><li><strong>Local Write</strong><p id="1022e7d3-01e5-80bb-8e33-f1fc2877079c" class="">Intermediate KVPs, kept locally. </p></li></ol><ol type="1" id="1022e7d3-01e5-80f5-8f52-e5b237e7c60c" class="numbered-list" start="5"><li><strong>Remote Read</strong><p id="1022e7d3-01e5-80da-8ef2-e4e3247f7669" class="">Once the cluster decides it’s time, it tells reduce workers theres some<em> intermediate-files</em> ready to download. Reduce workers do remote requests, asking for work. Once all ready, reduce is called. </p></li></ol><ol type="1" id="1022e7d3-01e5-80e1-8a02-ffb3a064ce84" class="numbered-list" start="6"><li><strong>Write</strong><p id="1022e7d3-01e5-8010-a831-e49d46c54254" class="">One file per reducer, containing the KVPs output from the reducer. </p></li></ol><h2 id="1022e7d3-01e5-8055-9d4c-e9a43adaec7d" class="">Distributed Group-By in MapReduce</h2><p id="bf5d4cb1-69d8-43d7-b4e9-f04447458db0" class="">How <strong>MapReduce</strong> handles the <strong>group-by</strong> operation in a distributed way: what happens within the <strong>Mapper</strong> phase and how <strong>spill</strong>, <strong>partitioning</strong>, <strong>sorting</strong>, and <strong>combining</strong> help manage large-scale data processing efficiently.</p><figure id="10b2e7d3-01e5-8030-b64c-f4f536a4afb2" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_19.46.21.png"><img style="width:480px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_19.46.21.png"/></a></figure><ul id="10b2e7d3-01e5-80c7-a303-d60533eb6460" class="bulleted-list"><li style="list-style-type:disc"><strong>combiner #1</strong> is an optimization. Because shuffling is the most expensive. The combiner reducers the size of the shuffle. Especially when theres small amount of keys. By making the intermediate files smaller, there’s less to send over the network during the shuffle. </li></ul><ul id="e0c4c6ae-4d97-489b-998a-554150df4cd9" class="bulleted-list"><li style="list-style-type:disc"><strong>combiner #2</strong> is not as crucial, but nice to have. its prepping, because reducer can’t run until all the inter. file come in. </li></ul><h3 id="10b2e7d3-01e5-80af-98bb-fd8284169288" class=""><strong>Circular Buffer and Spill</strong></h3><ul id="c06d2068-8a80-4252-9dcf-a6c9cd005e77" class="bulleted-list"><li style="list-style-type:disc">During the <em>Map phase,</em> each time the <code>context.write(key, value)</code> , KVPs are written to a <strong>circular buffer</strong> in memory.<ul id="10b2e7d3-01e5-80dd-9972-fadc3a3e379f" class="bulleted-list"><li style="list-style-type:circle"><strong>Circular Buffer </strong>prevents overloading memory by providing a temporary storage space for KVPs before they are written to disk.</li></ul><ul id="21094936-4552-44d1-85a5-f6769cf78a20" class="bulleted-list"><li style="list-style-type:circle">When the buffer reaches 80% capacity, the KVPs from the buffer <strong>spill </strong>to disk. This Ensures that 100% memory utilization doesn&#x27;t happen ⇒ mapper won’t stall. </li></ul></li></ul><h3 id="10b2e7d3-01e5-8090-837b-cdc23d0b93e6" class=""><strong>Spill Process: Partitioning and Sorting</strong></h3><ul id="a7102b10-8d48-4659-9146-0fc47a5fcca4" class="bulleted-list"><li style="list-style-type:disc">During spilling, the KVPs are <strong>partitioned</strong> and <strong>sorted</strong>, ensuring efficient data transfer and memory usage in the reducer phase. </li></ul><h3 id="10b2e7d3-01e5-805a-b249-cb4f2556f602" class=""><strong>3. Spill Files and Shuffle Phase</strong></h3><ul id="25542972-8d69-4581-975f-3098959a89b1" class="bulleted-list"><li style="list-style-type:disc">Once the KVPs are partitioned and sorted, they are written into <strong>spill files</strong> on disk. </li></ul><ul id="c2eab7f9-9504-4a67-99b3-833d0f49a2cf" class="bulleted-list"><li style="list-style-type:disc">These spill files will later be transferred to the reducers during the <strong>shuffle</strong> phase.</li></ul><h3 id="10b2e7d3-01e5-804a-98b4-ecf8efbe91d2" class=""><strong>4. Multi-Pass Merge Sorting and Combiner</strong></h3><ul id="10b2e7d3-01e5-808d-bb35-f5251b189e96" class="bulleted-list"><li style="list-style-type:disc">The <strong>sort</strong> during the shuffle involves a <strong>multi-pass merge</strong> of the spill files, which happens both in memory and on disk.</li></ul><ul id="32bf3777-2075-4b7b-973f-4d4708a853c2" class="bulleted-list"><li style="list-style-type:disc"><strong>Combiner</strong>: The <strong>combiner function</strong> can be applied during the merge process. The combiner works as a mini-reducer to combine KVPs with the same key before they are sent to the reducer, reducing the amount of data transferred over the network. However:<ul id="10b2e7d3-01e5-80eb-869d-ddc236825ab1" class="bulleted-list"><li style="list-style-type:circle"><strong>Optional Combiner</strong>: Merging of spill files is optional, meaning the combiner may not always be applied if the framework deems it unnecessary.</li></ul><ul id="10b2e7d3-01e5-8003-aa40-f05aa3ac8128" class="bulleted-list"><li style="list-style-type:circle"><strong>Multiple Passes</strong>: The combiner can be run multiple times, especially if you have many spill files. For example, the system may merge 11 spill files, run the combiner, and then, when more files are spilled, it merges those with the previously combined files.</li></ul></li></ul><h3 id="10b2e7d3-01e5-80d3-977e-f98eef30b56a" class=""><strong>Final Merge and Reduce Phase</strong></h3><ul id="10b2e7d3-01e5-806e-9589-cb262e6c8416" class="bulleted-list"><li style="list-style-type:disc">After all map outputs are copied over to the reducer machine, the final merge pass occurs, combining the sorted and partitioned KVPs from the spill files. The final merge outputs directly into the reducer, which processes the data to produce the final results.</li></ul><ul id="de0e648d-ed09-49a6-965f-70498e5ff282" class="bulleted-list"><li style="list-style-type:disc"><strong>When Does Reduce Begin?</strong><ul id="10b2e7d3-01e5-801a-aa8d-d2cfd75f4a5b" class="bulleted-list"><li style="list-style-type:circle">The <strong>reduce</strong> phase cannot start until <strong>all the map tasks are 100% complete</strong>. However, while the mapper is still working, the reducers can begin fetching the intermediate files (map outputs) from disk, and even run a <strong>combine</strong> on those files to optimize the process.</li></ul></li></ul><hr id="10b2e7d3-01e5-8099-b5bf-df3f32ac7238"/><h3 id="cd0d1c84-d8f5-4228-8f6a-d52ad1720bb7" class=""><strong>Progress Tracking: Mapper % and Reducer %</strong></h3><ul id="5697cfce-f6c0-4909-91d6-25f2a59e78cb" class="bulleted-list"><li style="list-style-type:disc"><strong>Mapper %</strong>: This indicates how much of the input file has been processed by the mapper, based on the percentage of bytes read.</li></ul><ul id="10b2e7d3-01e5-80a1-937f-ef742e2b28bb" class="bulleted-list"><li style="list-style-type:disc"><strong>Reducer %</strong>:<ul id="10b2e7d3-01e5-80f3-815a-fb4ce44ce40d" class="bulleted-list"><li style="list-style-type:circle"><strong>0-33%</strong>: This represents the phase where the reducers are fetching intermediate files from the mappers (remote reads).</li></ul><ul id="10b2e7d3-01e5-8089-a9d4-e1f42682f7ed" class="bulleted-list"><li style="list-style-type:circle"><strong>34-66%</strong>: This is the stage where the data is being merged and processed.</li></ul><ul id="5086f04a-0881-4492-8914-c2b387779921" class="bulleted-list"><li style="list-style-type:circle"><strong>67-100%</strong>: This final stage represents the reduce phase, where the data is being reduced and written to the final output.</li></ul></li></ul><hr id="151c3092-b8e4-4c9c-9efc-953c27b6392a"/><h3 id="10b2e7d3-01e5-80a0-8322-d94964a25bcd" class=""><strong>Summary</strong></h3><p id="10b83d74-6dd7-4fb8-bae4-f5bdcd91e46f" class="">These steps ensure that even with very large datasets, MapReduce can efficiently handle the <strong>group-by</strong> operation across many distributed machines: </p><ul id="10b2e7d3-01e5-808f-8c12-fb66bee885bc" class="bulleted-list"><li style="list-style-type:disc">The <strong>circular buffer</strong> allows for efficient in-memory processing of KVPs.</li></ul><ul id="eaaa41da-afe9-4a90-af11-88016ca2f3aa" class="bulleted-list"><li style="list-style-type:disc"><strong>Spill</strong> prevents the mapper from stalling by writing KVPs to disk once the buffer is 80% full.</li></ul><ul id="df377d18-cfbb-417f-9b8c-fedcdd268434" class="bulleted-list"><li style="list-style-type:disc">During spilling, the KVPs are <strong>partitioned</strong> and <strong>sorted</strong>, ensuring efficient data transfer and memory usage in the reducer phase. </li></ul><ul id="10b2e7d3-01e5-80bd-b325-f1c0a76cd158" class="bulleted-list"><li style="list-style-type:disc">The <strong>combiner</strong> is used to reduce the amount of intermediate data, but it&#x27;s optional and may be applied multiple times during the merge process.</li></ul><ul id="10b2e7d3-01e5-8082-84b3-f9a677bbbdbd" class="bulleted-list"><li style="list-style-type:disc">The <strong>multi-pass merge</strong> ensures that spill files are combined in a memory-efficient way before the final merge pass feeds data into the reducer.</li></ul><hr id="10b2e7d3-01e5-8035-b630-c82477a360b6"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">Physical View</summary><div class="indented"><ul id="10a2e7d3-01e5-80bb-84c8-c171f2af507b" class="bulleted-list"><li style="list-style-type:disc">multiple servers on a rack </li></ul><ul id="10a2e7d3-01e5-80ff-9af7-d3fbbde0c801" class="bulleted-list"><li style="list-style-type:disc">clusters of racks = data center </li></ul><figure id="10a2e7d3-01e5-8049-9b92-e18a582a0f21" class="image" style="text-align:center"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_18.27.03.png"><img style="width:288px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_18.27.03.png"/></a></figure><ul id="c79c8726-aa14-4589-9c3c-62876ad7f4e5" class="bulleted-list"><li style="list-style-type:disc"><strong>Capacity</strong>, <strong>latency</strong>, and <strong>bandwidth</strong> for reading data change depending on where the data is. <ul id="10a2e7d3-01e5-80e2-98d6-ed0ddd3b43ed" class="bulleted-list"><li style="list-style-type:circle">The lowest latency and highest bandwidth is achieved when the data we need is on our local server. <ul id="10a2e7d3-01e5-809b-aa3b-e2aa0406ed3f" class="bulleted-list"><li style="list-style-type:square">Latency: local machine &lt; remote machine (same rack) &lt; remote machine (diff rack) &lt; Remote Machine (diff. datacenter) </li></ul></li></ul><ul id="10a2e7d3-01e5-8020-9ef9-d3d25dea6110" class="bulleted-list"><li style="list-style-type:circle">We can increase <strong>capacity</strong> by utilizing other servers but at the cost of higher<strong> latency</strong> and lower <strong>bandwidth</strong>.</li></ul></li></ul><ul id="10a2e7d3-01e5-80a2-84be-cbec0a5596cc" class="bulleted-list"><li style="list-style-type:disc">We are limited by <em>bandwidth</em>, not <em>latency</em></li></ul><h3 id="10a2e7d3-01e5-80e4-a33f-d0b071b362c7" class="">Why is the shuffle the slowest part? </h3><p id="10b2e7d3-01e5-8082-a4ac-e198512fb15a" class="">The network is the bottleneck because transferring large amounts of data across machines takes significantly more time than local disk reads. Even if the data size is similar, <strong>network latency</strong> and <strong>bandwidth limits</strong> slow down the shuffle phase more than the initial data load (which is a read from local disk). </p></div></details><hr id="10a2e7d3-01e5-80e6-ae32-c58d7be9033f"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">Hadoop Distributed File System (HDFS) </summary><div class="indented"><p id="31f1815a-ec73-416c-8fb7-5765027ba0ab" class="">A distributed file-system </p><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10a2e7d3-01e5-8009-b14b-fadaf8e3e813"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_purple.svg"/></div><div style="width:100%"><p id="82d01f12-4b31-460f-ab59-291deb704d5b" class=""><strong>Example</strong></p><p id="10a2e7d3-01e5-8006-8f79-f3a45f2c42cb" class="">Assume that we have 20 identical networked servers each with 100 TB of disk space. How would you store a file on these server? This is the fundamental question in distributed file systems.</p><p id="2bdbb92e-5a43-4ddc-bfb9-af03d6128b38" class="">We can split the file into smaller <strong>chunks</strong> and assign the chunks (e.g., randomly) to the servers.</p><figure id="10a2e7d3-01e5-8049-a626-f7c11696aefb" class="image" style="text-align:center"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_18.33.13.png"><img style="width:384px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_18.33.13.png"/></a></figure></div></figure><p id="10a2e7d3-01e5-807f-af5c-e1d84790d906" class=""><strong>Problem: </strong>if any 1 server fails, you’ve lost part of the file forever</p><p id="35108d8f-7512-4e58-bcc7-87829279b8f9" class=""><strong>Solution: </strong>replication</p><h3 id="5e735c93-7bcf-4d98-ade8-bcf4c3f8cf62" class=""><strong>Fault Tolerance / Replication</strong></h3><ul id="a9c0e9fc-9cef-4ed4-937a-c4ae1f066dcf" class="bulleted-list"><li style="list-style-type:disc">Store each chunk on multiple servers</li></ul><ul id="d5db3e04-4e35-46de-9dab-321689455260" class="bulleted-list"><li style="list-style-type:disc">if a server fails there is a backup. </li></ul><ul id="10a2e7d3-01e5-80e6-a763-c7ecdc2d049f" class="bulleted-list"><li style="list-style-type:disc">The number of copies determines how much resilience we want.</li></ul><hr id="f0a5f82c-9757-47b8-a61c-49c9b0d5a7fc"/><h3 id="10b2e7d3-01e5-8043-8024-cd7513ac6166" class="">HDFS Properties </h3><ul id="10a2e7d3-01e5-80f3-a1b3-cd0968c531f0" class="bulleted-list"><li style="list-style-type:disc">Very Large Distributed File System<ul id="10a2e7d3-01e5-8093-9512-cc94c486b338" class="bulleted-list"><li style="list-style-type:circle">runs on 10K servers</li></ul><ul id="41bb8b2f-5624-43ff-974e-7fe3c4e3a96f" class="bulleted-list"><li style="list-style-type:circle">can host 100+ million files</li></ul></li></ul><ul id="8b0d1b8c-148b-45f6-8e76-5132c940cf1c" class="bulleted-list"><li style="list-style-type:disc">Assumes Commodity Hardware<ul id="06c7d523-205d-4f86-b221-403beb674658" class="bulleted-list"><li style="list-style-type:circle">Files are replicated to handle hardware failure</li></ul><ul id="10a2e7d3-01e5-8000-b79f-cb28b06f1859" class="bulleted-list"><li style="list-style-type:circle">Detect failures and recover from them </li></ul></li></ul><ul id="e974956d-f4ef-4044-a7c1-6225f6a3d6bb" class="bulleted-list"><li style="list-style-type:disc">Optimized for Batch Processing<ul id="10a2e7d3-01e5-805c-822a-e357045490a6" class="bulleted-list"><li style="list-style-type:circle">Not optimized for random access; load a file, do a parallel scan of it start 2 finish (which is what map reduce does). </li></ul><ul id="10a2e7d3-01e5-807e-8305-f95aabcd2ae7" class="bulleted-list"><li style="list-style-type:circle">Provides very high aggregate bandwidth</li></ul></li></ul><ul id="10a2e7d3-01e5-808b-98b6-e419a22e67df" class="bulleted-list"><li style="list-style-type:disc">Data Coherency<ul id="10a2e7d3-01e5-8019-bf63-eb0c372fdae6" class="bulleted-list"><li style="list-style-type:circle">Write-once-read-many access model</li></ul><ul id="10a2e7d3-01e5-80b1-9844-f645d29aee5e" class="bulleted-list"><li style="list-style-type:circle">Client <strong>can only append to existing files </strong><ul id="10a2e7d3-01e5-8077-9f91-c8fdde240d5c" class="bulleted-list"><li style="list-style-type:square">otherwise, if you make a change, need to ensure the replicated copy knows </li></ul></li></ul></li></ul><ul id="10a2e7d3-01e5-80a8-8989-de76138c7120" class="bulleted-list"><li style="list-style-type:disc">Files are broken up into blocks<ul id="10a2e7d3-01e5-80a2-8b43-c1cc597ea52d" class="bulleted-list"><li style="list-style-type:circle">Typically 64MB block size</li></ul><ul id="10a2e7d3-01e5-8091-92d1-f20e504b2c7d" class="bulleted-list"><li style="list-style-type:circle">Each block replicated on multiple DataNodes </li></ul></li></ul><ul id="61037ad7-2bde-4e98-a1ce-581a2632eb76" class="bulleted-list"><li style="list-style-type:disc">Intelligent Client<ul id="71818d46-3afb-4dd0-8a32-f1835879aa64" class="bulleted-list"><li style="list-style-type:circle">Client can find location of blocks</li></ul><ul id="a3ba55e2-c7fa-478b-82a5-720d4aaaafca" class="bulleted-list"><li style="list-style-type:circle">Client accesses data directly from DataNode</li></ul></li></ul><p id="10a2e7d3-01e5-80d0-816e-cd7208678087" class=""><strong>Note: </strong>It cannot perform some of the typical operations that other file systems can do like random write. Instead it is optimized for large sequential reads and append only writes.</p></div></details><hr id="10a2e7d3-01e5-8029-bb52-dfa4c8b08ec8"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">HDFS Architecture</summary><div class="indented"><p id="59c3b330-2033-4358-a86b-4b6de287c4e8" class="">How Hadoop stores large files across many machines.</p><p id="10b2e7d3-01e5-801a-9e53-e0ebd6fde2d9" class="">Only output files are stored on HDFS, not code. </p><figure id="10a2e7d3-01e5-80ae-8921-ec140782d6f1" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_18.41.04.png"><img style="width:576px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_18.41.04.png"/></a></figure><h2 id="10b2e7d3-01e5-8054-a1c6-dd459a68d01d" class="">Key Components</h2><ul id="10b2e7d3-01e5-808d-8fc5-d8f441af5761" class="bulleted-list"><li style="list-style-type:disc"><strong>Namenode (NN)</strong>:<ul id="10b2e7d3-01e5-80b5-b0d2-fa32e97e29b3" class="bulleted-list"><li style="list-style-type:circle">The <em>master</em> of HDFS, managing the overall file system. It does not store actual data but manages metadata.</li></ul><ul id="10b2e7d3-01e5-8026-944b-eb3fd0e57e34" class="bulleted-list"><li style="list-style-type:circle">The <em>namenode</em> knows where each piece of data is stored in the system and maps filenames to blocks, and blocks to specific datanodes.</li></ul></li></ul><ul id="10b2e7d3-01e5-8032-9da6-d7e0592557c2" class="bulleted-list"><li style="list-style-type:disc"><strong>Datanodes (DN)</strong>:<ul id="bb90d21e-90c4-42b9-b323-280f98acf009" class="bulleted-list"><li style="list-style-type:circle">These are the <em>workers</em> in the system. They store the <strong>actual data blocks</strong> on the <strong>local file system </strong>and report back to the <em>namenode</em> on the status of the data they hold.</li></ul><ul id="d284c641-c10b-4b93-8941-ce298519c496" class="bulleted-list"><li style="list-style-type:circle">Each block is <strong>replicated</strong> across several datanodes for <strong>fault tolerance</strong>.</li></ul></li></ul><ul id="344dff26-9ee3-47fc-a05d-8e45f0776236" class="bulleted-list"><li style="list-style-type:disc"><strong>Client</strong>:<ul id="10b2e7d3-01e5-80f6-85da-eb2c5f7e6611" class="bulleted-list"><li style="list-style-type:circle">A client interacts with the HDFS to read/write files.</li></ul><ul id="10b2e7d3-01e5-80f3-b6b8-c87302f2e230" class="bulleted-list"><li style="list-style-type:circle">It first communicates with the <em>namenode</em> to get the metadata about where files are located, and then directly interacts with <em>datanodes</em> to fetch or write data.</li></ul></li></ul><h3 id="c056bd19-4451-4d8d-a949-d001e94ef29f" class="">How It Works:</h3><ol type="1" id="f86e3597-7043-44f3-9f62-feae7dababdc" class="numbered-list" start="1"><li><strong>File Storage Process</strong>:<ul id="5cfc1395-e0fd-4626-b52b-f1c55bfe5e20" class="bulleted-list"><li style="list-style-type:disc">Files are split into <strong>blocks</strong> (default size: 128MB) and stored across multiple <strong>datanodes</strong>.</li></ul></li></ol><ol type="1" id="23c1692a-2a23-44dd-b8f9-ea608ac393c7" class="numbered-list" start="2"><li><strong>Redundancy and Replication</strong>:<ul id="10b2e7d3-01e5-803d-a74b-cbe85543c2ee" class="bulleted-list"><li style="list-style-type:disc">A typical file will have its blocks replicated across several datanodes to ensure fault tolerance.</li></ul><ul id="92ffbd3a-1c36-4c60-b64c-bf54ad6c624c" class="bulleted-list"><li style="list-style-type:disc">If a <strong>datanode</strong> fails, the <em>namenode</em> ensures that new copies of the data are created on other <em>datanodes</em> to maintain the desired level of replication.</li></ul><ul id="10b2e7d3-01e5-80d9-93e2-d1a695876554" class="bulleted-list"><li style="list-style-type:disc">(default replication factor: 3)</li></ul></li></ol><h3 id="10b2e7d3-01e5-80d2-bf03-cb6112ed0a0b" class="">Namenode (NN) Responsibilities</h3><ol type="1" id="10b2e7d3-01e5-8049-939e-c93f59b2fc72" class="numbered-list" start="1"><li><strong>Managing File System Metadata</strong>:<ul id="10b2e7d3-01e5-80b9-ac8d-f14ca51a5003" class="bulleted-list"><li style="list-style-type:disc">The <em>namenode</em> stores metadata in memory, such as:<ul id="10b2e7d3-01e5-8052-950c-e96fc9a7d981" class="bulleted-list"><li style="list-style-type:circle">List of all files and directories.</li></ul><ul id="10b2e7d3-01e5-805f-a386-fc1a0c1f1bb3" class="bulleted-list"><li style="list-style-type:circle">Mapping of files to blocks.</li></ul><ul id="10b2e7d3-01e5-804a-b1e2-dcf0fcb54ce3" class="bulleted-list"><li style="list-style-type:circle">Locations of each block on the <em>datanodes. </em></li></ul><ul id="10b2e7d3-01e5-805c-a1f7-f9e3dca65dee" class="bulleted-list"><li style="list-style-type:circle">File attributes, e.g. creation time, replication factor</li></ul></li></ul><ul id="10b2e7d3-01e5-8051-a191-ea0a40a3b50a" class="bulleted-list"><li style="list-style-type:disc">metadata is always kept in main memory for fast access.</li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-808b-b247-cc69f91d0c81" class="numbered-list" start="2"><li><strong>Cluster Configuration Management </strong><ul id="1f11aed0-4f30-4e7a-b212-6d25eea9cf60" class="bulleted-list"><li style="list-style-type:disc">the physical layout of DN’s </li></ul><ul id="14f3c0a1-37b9-4cda-bafa-1fc9ba58cf34" class="bulleted-list"><li style="list-style-type:disc">for determining closest DN to access</li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-808d-9ec2-d1e6f1ff69fa" class="numbered-list" start="3"><li><strong>Replication Engine</strong>:<ul id="10b2e7d3-01e5-804f-a3b7-c254663eb71f" class="bulleted-list"><li style="list-style-type:disc">The <em>namenode</em> decides where to place replicas of each data block.</li></ul><ul id="f1959af8-c0f4-49fc-b79f-946ab757633f" class="bulleted-list"><li style="list-style-type:disc">It balances disk usage across datanodes and network traffic to ensure efficiency.</li></ul><ul id="10b2e7d3-01e5-806c-b87f-f34e657e65ad" class="bulleted-list"><li style="list-style-type:disc">If a <em>datanode</em> fails, it selects new <em>datanodes</em> to hold additional copies.</li></ul></li></ol><ol type="1" id="efb551a6-7b67-48fd-984b-446b90d727e6" class="numbered-list" start="4"><li><strong>Transaction Log</strong>:<ul id="10b2e7d3-01e5-8059-8fe3-dd8adc78799c" class="bulleted-list"><li style="list-style-type:disc">The <em>namenode</em> maintains a log of changes to the file system, such as file creation, deletion, and block allocation.</li></ul></li></ol><h3 id="10b2e7d3-01e5-80a7-8483-cfdacc48b8c7" class="">Datanode (DN) Responsibilities:</h3><ol type="1" id="10b2e7d3-01e5-808f-a6e1-f2ed9f80463c" class="numbered-list" start="1"><li><strong>Storing Blocks</strong>:<ul id="3a16eece-b62d-46c1-9c36-1ec43b5a2e85" class="bulleted-list"><li style="list-style-type:disc">Datanodes store the actual data in blocks (in the local file system), with each block having associated metadata like checksums to ensure data integrity.</li></ul><ul id="10b2e7d3-01e5-809b-a024-d9e7b41347ec" class="bulleted-list"><li style="list-style-type:disc">Stores metadata of a block (e.g. Check sum)</li></ul><ul id="1e91476e-bde9-491b-bbc0-e55347532e0b" class="bulleted-list"><li style="list-style-type:disc">Datanodes periodically report the status of all blocks to the <em>namenode</em> through a <strong>block report</strong>.</li></ul><ul id="10b2e7d3-01e5-8027-9d11-d8265678024f" class="bulleted-list"><li style="list-style-type:disc">can send it directly to client w’out going through NN </li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-802a-9de9-f2a4b71d6009" class="numbered-list" start="2"><li><strong>Pipelining</strong>:<ul id="cbb27a25-3064-488c-85f4-6fcacd3d5360" class="bulleted-list"><li style="list-style-type:disc">When writing data, the client writes to a datanode, which then forwards the data to other datanodes to replicate it (as per the replication factor).</li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-80fa-9516-c6c58d4cd6a1" class="numbered-list" start="3"><li><strong>Heartbeat</strong>:<ul id="10b2e7d3-01e5-8037-b0c2-d5b9c5a86fda" class="bulleted-list"><li style="list-style-type:disc">Every 3 seconds, <em>datanodes</em> send a heartbeat signal to the <em>namenode</em> to indicate they are functioning correctly. If a heartbeat is missed, the <em>namenode</em> assumes the <em>datanode</em> has failed and initiates replication of its data blocks on other <em>datanodes</em>.</li></ul></li></ol><h3 id="10b2e7d3-01e5-806d-9396-f8c81939c90c" class="">Block Replacement Policy:</h3><ul id="10b2e7d3-01e5-8091-890f-fa37848903cb" class="bulleted-list"><li style="list-style-type:disc">The default HDFS policy is to store <strong>3 replicas</strong> of each block:<ol type="1" id="10b2e7d3-01e5-8021-a596-df82adba98f9" class="numbered-list" start="1"><li><strong>First replica</strong> is stored on the same node as the client.</li></ol><ol type="1" id="10b2e7d3-01e5-8080-8721-eaa7b6bc02b6" class="numbered-list" start="2"><li><strong>Second replica</strong> is stored on a node in a different rack (to protect against rack failures).</li></ol><ol type="1" id="10b2e7d3-01e5-8083-b6ed-f48a41169b66" class="numbered-list" start="3"><li><strong>Third replica</strong> is stored on another node in the same remote rack.</li></ol></li></ul><ul id="10b2e7d3-01e5-8011-940c-c3529e147ae5" class="bulleted-list"><li style="list-style-type:disc">This policy strikes a balance between <strong>safety</strong> (replication across racks) and <strong>efficiency</strong> (storing data close to each other to minimize network traffic).</li></ul><ul id="10b2e7d3-01e5-8030-9103-dbe49c566001" class="bulleted-list"><li style="list-style-type:disc"><strong>Client Reads</strong>: Clients will always attempt to read from the nearest replica to minimize latency.</li></ul><h2 id="10b2e7d3-01e5-804f-8b12-d0c9806d6243" class="">Summary of Operations:</h2><ol type="1" id="ed82e7b5-7cde-4693-9941-461a334a527b" class="numbered-list" start="1"><li><strong>Client Requests a File</strong>:<ul id="10b2e7d3-01e5-80b2-9ea4-d328b6086d34" class="bulleted-list"><li style="list-style-type:disc">The client asks the <em>namenode</em> for the locations of the blocks of a file.</li></ul><ul id="55f9a188-189a-473c-a5cc-d6dabed7a32b" class="bulleted-list"><li style="list-style-type:disc">The <em>namenode</em> returns the block locations, and the client reads data directly from the <em>datanodes</em>.</li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-803e-8c6e-fae5ab21bdac" class="numbered-list" start="2"><li><strong>Data Writing</strong>:<ul id="10b2e7d3-01e5-806a-83d4-ca2275fa027c" class="bulleted-list"><li style="list-style-type:disc">When writing, the client splits the file into blocks and writes each block to a <em>datanode</em>. The <em>datanode</em> then forwards the block to other datanodes to create replicas.</li></ul></li></ol><ol type="1" id="8e32ca6f-f407-425e-9b64-37f86a668e26" class="numbered-list" start="3"><li><strong>Handling Failures</strong>:<ul id="5b4531b2-7ccd-4ca9-82d8-a1d297244838" class="bulleted-list"><li style="list-style-type:disc">If a datanode fails, the <em>namenode</em> replicates the blocks from the failed node to other healthy datanodes to maintain data integrity.</li></ul></li></ol><p id="10b2e7d3-01e5-8007-8468-ee65c303f68b" class="">HDFS ensures high availability and fault tolerance through its replication strategy, while keeping the system efficient by reading from the nearest replica.</p></div></details><hr id="10a2e7d3-01e5-8044-9ef4-cb875ae1628d"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">Hadoop Cluster Architecture</summary><div class="indented"><p id="10b2e7d3-01e5-8095-8517-e6345e909458" class=""><strong>Datanodes</strong> store blocks; <strong>worker nodes</strong> handle computation.</p><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-8078-8456-dfb714aa3843"><div style="font-size:1.5em"><span class="icon">💡</span></div><div style="width:100%"><p id="de9081ac-bd84-4af8-917a-3aa8bdbd74a4" class=""><strong>(Compute | Data) Intensive</strong></p><hr id="f4ee3fee-9e66-4d69-a72b-58cdaaf7a077"/><ul id="10b2e7d3-01e5-8042-bfcd-cc8e3f0f6cb7" class="bulleted-list"><li style="list-style-type:disc">compute intensive: <ul id="b776d4fd-8b3a-48e5-b472-2be4d188b3a2" class="bulleted-list"><li style="list-style-type:circle">bottle neck = cpu</li></ul><ul id="9fe8724d-bde7-447f-a957-3b08896f39d8" class="bulleted-list"><li style="list-style-type:circle">don’t care about (file transfer to worker-machine)-latency </li></ul></li></ul><ul id="10b2e7d3-01e5-8067-adcb-e6500c7522c4" class="bulleted-list"><li style="list-style-type:disc">data-intensive: <ul id="69cf8cc9-f2c0-45f2-962f-0fb5f91b98a3" class="bulleted-list"><li style="list-style-type:circle">file-system is the bottleneck</li></ul><ul id="d3854ee0-07f9-4232-80b4-9bf8449a5773" class="bulleted-list"><li style="list-style-type:circle">want Files local to the workers </li></ul></li></ul></div></figure><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>[option 1] Storage Area Network (SAN)</strong></summary><div class="indented"><figure id="10b2e7d3-01e5-8014-868a-d07b8c2f8a1d" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_19.31.04.png"><img style="width:480px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_19.31.04.png"/></a></figure><p id="10b2e7d3-01e5-809f-9036-efaf399b9ee2" class="">A SAN provides centralized storage for worker nodes. </p><ul id="10b2e7d3-01e5-80a9-81f7-ec749a125538" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-teal"><strong>[SAN] Compute-Intensive Tasks</strong></mark><mark class="highlight-teal">:</mark><p id="980f9d37-6c8d-4b0d-b2e3-708a676157eb" class="">For tasks requiring heavy computation, network delays from SAN setups are negligible, as computation time dominates.</p></li></ul><ul id="10b2e7d3-01e5-803b-9548-f88418940927" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-red"><strong>[SAN] Data-Intensive Tasks</strong></mark><mark class="highlight-red">:</mark><p id="039069a3-dd3b-4fcd-adeb-5f99c2a11a7d" class="">For tasks involving large datasets, network communication costs are significant. </p></li></ul></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">[option 2] Co-locating Storage and Computation in Hadoop</summary><div class="indented"><p id="10b2e7d3-01e5-800e-a430-e7218c81e976" class="">Instead of moving large datasets across the network to worker nodes, Hadoop <strong>moves computation to the data</strong>. By co-locating data and computation, Hadoop reduces the need for data transfers, optimizing performance for large datasets.</p><ul id="b7433a1b-0fe9-4374-a643-fb0bfe21f673" class="bulleted-list"><li style="list-style-type:disc"><strong>Co-location</strong>:<p id="10b2e7d3-01e5-80ba-8726-f9dda3e7ca26" class="">Each node in the cluster stores data and performs computation. This allows Hadoop to assign tasks to nodes that already hold the relevant data, minimizing network traffic.</p></li></ul><ul id="10b2e7d3-01e5-809d-bf77-c2f3bafa2344" class="bulleted-list"><li style="list-style-type:disc"><strong>Optimization</strong>:<p id="10b2e7d3-01e5-80e8-b403-f6ed70076523" class="">When Hadoop assigns MapReduce tasks, it prioritizes placing tasks on nodes that already store the required data. If the data is processed where it resides, no data transfer is needed across the network, reducing overhead.</p></li></ul><h3 id="10b2e7d3-01e5-80ac-adb2-e8940aa87574" class="">Hadoop Cluster Components</h3><figure id="10b2e7d3-01e5-80f1-aacb-f4a3a058b720" class="image"><a href="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_19.40.08.png"><img style="width:432px" src="02%20%E2%80%94%20Map%20Reduce/Screenshot_2024-09-23_at_19.40.08.png"/></a></figure><ol type="1" id="10b2e7d3-01e5-80a4-ac82-eeacebbcda30" class="numbered-list" start="1"><li><strong>Node Manager</strong>:<p id="10b2e7d3-01e5-809e-b300-e5ef9e0ba895" class="">Manages task execution on individual nodes, ensuring the most efficient use of resources on that node.</p></li></ol><ol type="1" id="826c01f0-d984-4286-a553-ff257594d2b8" class="numbered-list" start="2"><li><strong>Resource Manager</strong>:<p id="10b2e7d3-01e5-806d-8079-c5e0070296e7" class="">Oversees the entire cluster&#x27;s resource allocation, ensuring tasks are distributed efficiently across the available nodes.</p></li></ol><ol type="1" id="10b2e7d3-01e5-80fe-8f1c-f715bd651b64" class="numbered-list" start="3"><li><strong>DataNode (DN)</strong>:<p id="10b2e7d3-01e5-80ac-a419-e9a6659122aa" class="">Stores data locally on a Linux file system, making data available for processing without network transfer during the Map phase.</p></li></ol><h3 id="f2043b67-0b52-485d-a6a9-87321881a509" class="">Network Costs</h3><ul id="10b2e7d3-01e5-8019-bc66-feb6bbd7dff5" class="bulleted-list"><li style="list-style-type:disc"><strong>Initial Load</strong>:<p id="10b2e7d3-01e5-80a7-8973-cf472d3ef0d7" class="">Map tasks typically access data stored locally, avoiding network usage.</p></li></ul><ul id="10b2e7d3-01e5-8063-b609-cd7870273d8e" class="bulleted-list"><li style="list-style-type:disc"><strong>Shuffle Phase</strong>:<p id="10b2e7d3-01e5-805d-ad90-e846c9bee363" class="">Data is exchanged between nodes during the shuffle phase, where results from the map tasks are sent to reducers. This is the costly network operation that Hadoop tries to minimize.</p></li></ul></div></details><p id="a54fe1a2-2fe3-4311-9b10-1ae755b003bb" class="">
</p></div></details><hr id="10a2e7d3-01e5-8072-a461-ead85e2b0102"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">Combiner Design (for Calculating the Mean)</summary><div class="indented"><h2 id="10b2e7d3-01e5-8006-afde-f92bc706a7a2" class="">Ex 1: Standard Reducer for Mean</h2><h3 id="196434fd-5e66-494b-8bd0-8381fe65ef0b" class=""><strong>Mapper</strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-8063-b15d-e170f21a0ec6" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def map(key: String, value: Int):
    emit(key, value)</code></pre><p id="10b2e7d3-01e5-8026-a701-c10e43205ae4" class=""><strong>Example Output:</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f3b659c3-46ae-4d80-8b34-62e221a9dcdc" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">(a,7), (a, 18), (c,4), (b,1), (c,10), (a,3)</code></pre><h3 id="10b2e7d3-01e5-803c-a72d-ca8ef800a35f" class="">Reducer:</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7a31015e-7ffe-44b0-994f-fd4dcff9dc4d" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def reduce(key: String, values: List[Int]):
    sum = 0
    count = 0
    for value in values:
        sum += value
        count += 1
    emit(key, sum / count)
</code></pre><ul id="10b2e7d3-01e5-80f5-9902-e61c7868974d" class="bulleted-list"><li style="list-style-type:disc"><strong>Combiner can&#x27;t be used here</strong> since it won&#x27;t reduce network traffic effectively.</li></ul><ul id="10b2e7d3-01e5-800a-9997-fd79a9972c35" class="bulleted-list"><li style="list-style-type:disc">Combiner requires that output types match input types, but the reducer aggregates values into a final result.</li></ul><h2 id="10b2e7d3-01e5-8062-bb9f-dd8fb65b7ad2" class="">Ex 2: Improved Mean Calculation with Combiner</h2><p id="10b2e7d3-01e5-808e-b34c-c26f95601ea4" class="">To make the combiner work, we need to adjust the types emitted by the map function.</p><h3 id="10b2e7d3-01e5-80e1-9ad1-f6dec43f751e" class="">Updated Mapper:</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-80b3-883b-ee7180035ae3" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def map(key: String, value: Int):
    emit(key, (value, 1))  # Emit a tuple (value, count)</code></pre><h3 id="10b2e7d3-01e5-8067-96a6-db1e9068e49b" class="">Updated Combiner:</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-8039-a76f-e6bd94ce798e" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def combine(key: String, values: List[(Int, Int)]):
    sum = 0
    count = 0
    for (v, c) in values:
        sum += v
        count += c
    emit(key, (sum, count))  # Output sum and count
</code></pre><h3 id="05bfa72d-289d-4a2d-ac3d-f95edf3d0a88" class="">Updated Reducer:</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-80d7-8648-fa51d3c2263b" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def reduce(key: String, values: List[(Int, Int)]):
    sum = 0
    count = 0
    for (v, c) in values:
        sum += v
        count += c
    emit(key, sum / count)
</code></pre><ul id="10b2e7d3-01e5-80f6-a4cc-e039dfe200cd" class="bulleted-list"><li style="list-style-type:disc">The combiner works because the input and output types match.</li></ul><ul id="10b2e7d3-01e5-8026-9972-e2bcc4e78888" class="bulleted-list"><li style="list-style-type:disc">The <strong>combiner</strong> helps reduce the amount of data shuffled over the network by aggregating intermediate results locally.</li></ul><hr id="040a4592-6d3b-4539-aefd-29220028c348"/><h3 id="10b2e7d3-01e5-805c-8d4e-f36d51796700" class="">Performance of Combiners</h3><ul id="10b2e7d3-01e5-8079-816a-ff0f39a57ca8" class="bulleted-list"><li style="list-style-type:disc"><strong>Without combiner</strong>: ~120 seconds for 200 million integers, 3 unique keys.</li></ul><ul id="10b2e7d3-01e5-80b5-b6ed-c6f291333781" class="bulleted-list"><li style="list-style-type:disc"><strong>With combiner</strong>: ~90 seconds.</li></ul><hr id="10b2e7d3-01e5-80f6-bcf7-d012671835b3"/><h2 id="9021fb70-e30d-4067-8d05-ebc060431d8a" class="">In-Mapper Combining (IMC)</h2><p id="10b2e7d3-01e5-8031-84f0-c16a95e09ded" class="">Combiners work at the file merge level, but combining <strong>in-memory</strong> can further improve performance.</p><p id="10b2e7d3-01e5-80d7-a11b-deef9c7a4bc6" class=""><strong>How? </strong>Preserve state across calls to map</p><p id="15a2e7d3-01e5-8032-be26-ca0c269d7d13" class=""><strong>Caution:</strong> requires enough memory to store counts and sums for all keys. If there are too many keys, this method may not be feasible.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-805e-a135-f001e78bcb58" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">class mapper:

    def setup(self):
		    # initializes data structures before mapping.
        self.sums = Map()    # Dictionary to hold sums per key
        self.counts = Map()  # Dictionary to hold counts per key

    def map(self, key, value):
        self.sums[key] += value
        self.counts[key] += 1

    def cleanup(self):
		    # called after the map tasks are completed to emit final results.
        for key in self.counts:
            emit(key, (self.sums[key], self.counts[key]))
</code></pre><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="76bb36e4-d26a-4a87-b335-720b4f771bf4"><div style="font-size:1.5em"><span class="icon">💡</span></div><div style="width:100%"><p id="95f2ba9a-fa69-4429-88b4-0b90eab8cbcb" class="">In-Mapper Combining (IMC) can be used in the <strong>reducer</strong> phase even though values are already grouped by key. The <strong>key difference</strong> is that the reducer can change key and value types and emit more flexible outputs.</p><ul id="10b2e7d3-01e5-8094-aede-d08ec1c9f98b" class="toggle"><li><details open=""><summary><strong>why would you? </strong></summary><ol type="1" id="10b2e7d3-01e5-8078-87f5-ead70b8c7111" class="numbered-list" start="1"><li><strong>Flexibility in Output</strong>: The <strong>reducer</strong> is not restricted to emitting the same key-value types that it receives. It can change both the key and value types as needed, allowing for more flexible aggregation or transformation logic.</li></ol><ol type="1" id="10b2e7d3-01e5-8021-a77a-ec10ae054607" class="numbered-list" start="2"><li><strong>Efficiency</strong>: Even though values are grouped by key when they reach the reducer, there might still be opportunities for optimization. For example:<ul id="10b2e7d3-01e5-803b-9e9d-ed804dcee6d8" class="bulleted-list"><li style="list-style-type:disc">If a large number of values need to be processed for a single key, you can accumulate intermediate results (e.g., partial sums, counts) within the reducer, reducing the number of times you emit values.</li></ul><ul id="853b86d3-f451-4058-9f8a-79506f0bd84f" class="bulleted-list"><li style="list-style-type:disc">This reduces the number of key-value pairs that need to be processed in subsequent stages, potentially improving performance.</li></ul></li></ol><ol type="1" id="10b2e7d3-01e5-80c1-a886-f29eb445ae8c" class="numbered-list" start="3"><li><strong>Memory Optimization</strong>: By accumulating values within the reducer (in-memory combining), you might minimize the number of output operations or avoid emitting unnecessary intermediate key-value pairs. This is particularly helpful if the reducer performs multiple passes on the same key or if there&#x27;s an opportunity to further condense the data.</li></ol><h3 id="10b2e7d3-01e5-809f-bbad-cbb71d815550" class=""></h3></details></li></ul></div></figure><figure class="block-color-purple_background callout" style="white-space:pre-wrap;display:flex" id="10b2e7d3-01e5-80d3-882c-c1bc1467c3c9"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/report_purple.svg"/></div><div style="width:100%"><p id="3d603a8a-5664-48ff-b01d-35fc72313f21" class=""><strong>Ex — Word count (using IMC)</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-8035-a3d0-ec0c8556957d" class="code"><code class="language-Python">class mapper:
    def setup(self):
        counts = HashMap()

    def map(self, key: Long, value: String):
        for word in tokenize(value):
            counts[word] += 1

    def cleanup(self):
        for (key, count) in counts:
            emit(key, count)</code></pre><p id="10b2e7d3-01e5-80f0-b58a-d193d1554137" class=""><strong>Feasibility depends on memory capacity</strong> and vocabulary size.</p><ul id="10b2e7d3-01e5-80c8-9507-ea3cc4a12518" class="bulleted-list"><li style="list-style-type:disc">If fewer than 1M unique words, ~24MB of memory should suffice:<ul id="10b2e7d3-01e5-8097-996c-d178afcb7e74" class="bulleted-list"><li style="list-style-type:circle">4MB for counts (if <code>int</code>)</li></ul><ul id="10b2e7d3-01e5-804e-a0d7-c33c7392682a" class="bulleted-list"><li style="list-style-type:circle">~8MB for keys, plus some overhead.</li></ul></li></ul></div></figure></div></details><hr id="10b2e7d3-01e5-8034-b23f-f03dc878cd0a"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">Co-Occurrence</summary><div class="indented"><p id="10b2e7d3-01e5-8005-bd4d-c28ceaf19491" class=""><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> : # of times word <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span><span>﻿</span></span> and word <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span><span>﻿</span></span> co-occur in some context. </p><ul id="1d90827c-e605-41d1-9166-c1dcfb64ce9d" class="bulleted-list"><li style="list-style-type:disc">e.g, # times <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span><span>﻿</span></span> followed <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span><span>﻿</span></span> in a sentence </li></ul><ul id="10b2e7d3-01e5-807c-ac79-ce2c59a49047" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">N\times N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span><span>﻿</span></span>, for vocabulary size <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span><span>﻿</span></span></li></ul><h3 id="10b2e7d3-01e5-808a-904b-cdfb1f5371d9" class=""><strong>2 Approaches:</strong></h3><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Pairs:  Computing Cells of <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span><span>﻿</span></span></summary><div class="indented"><p id="ab0a4e6e-00d3-4209-8fa2-322330b77bb4" class="">Computing individual Cells </p><p id="c833e6f0-c62f-4848-bd3e-648940e34819" class=""><strong>Mapper: </strong><div class="indented"><p id="10b2e7d3-01e5-80ae-8388-de1d7bd18feb" class="">Sentence → <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">((a,b),1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> for all pairs <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a,b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span></span></span></span></span><span>﻿</span></span> in the sentence </p></div></p><p id="f0cac605-c02b-44c0-9049-b413cae7d0a7" class=""><strong>Reducer:</strong><div class="indented"><p id="10b2e7d3-01e5-80e5-89e9-c2eeb6caede8" class="">Pair of words, list of counts → pair of words, count</p></div></p><p id="10b2e7d3-01e5-806c-a0f5-edf06f97fb3f" class=""><strong>Note:  </strong>In this case the reducer function can also serve as the combiner</p><h3 id="10b2e7d3-01e5-80fc-bf34-f96032b0a830" class=""><strong>PseudoCode</strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9b663f87-8fcb-4bfa-b401-f36c424944b0" class="code"><code class="language-Python">def map(key : Long, value: String):
	for u in tokenize(value):
		for each v that coöccurs with u in value:
			emit((u, v), 1)

def reduce(key: (String, String), values: List[Int]):
	for value in values:
		sum += value
		emit(key, sum)</code></pre><p id="10c2e7d3-01e5-80d0-bb3e-c443eb5cbbf3" class=""><strong>Note: </strong>we can pick whatever definition of “co-occurs” we like (e.g., within 2 words from). </p><h3 id="10b2e7d3-01e5-80f9-bb54-c0ba4e2b4405" class="">Analysis</h3><ul id="10b2e7d3-01e5-8019-8176-f3f24ddf11e4" class="bulleted-list"><li style="list-style-type:disc">Easy to implement &amp;  understand </li></ul><ul id="10b2e7d3-01e5-805d-a298-c1695a2989cd" class="bulleted-list"><li style="list-style-type:disc">A lot of pairs! <em>(for the shuffle)</em></li></ul><ul id="24d4e29a-3fe8-4898-84b1-6bb6231d6fd0" class="bulleted-list"><li style="list-style-type:disc"><strong>Combiner effectiveness:</strong> Low—many unique pairs, so few are reduced.</li></ul></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0">Stripes: Computing Rows of <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span><span>﻿</span></span></summary><div class="indented"><p id="10b2e7d3-01e5-8044-9d95-cda8b33b93c6" class="">Computing individual Rows</p><p id="10b2e7d3-01e5-8050-b963-df815d2a1e3c" class=""><strong>Mapper: </strong><div class="indented"><p id="10b2e7d3-01e5-8051-afbd-f626af3e3e16" class="">Sentence → <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mo stretchy="false">{</mo><mtext> </mtext><msub><mi>b</mi><mn>1</mn></msub><mo>:</mo><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>b</mi><mi>m</mi></msub><mo>:</mo><msub><mi>c</mi><mi>m</mi></msub><mtext> </mtext><mo stretchy="false">}</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(a, \set{b_1:c_1, \dots,b_m:c_m})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">{</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">})</span></span></span></span></span><span>﻿</span></span> </p><ul id="43299dcb-0a36-4510-82df-e533c1d6b813" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span></span><span>﻿</span></span> is a word from input </li></ul><ul id="10b2e7d3-01e5-806e-b275-cd36c09e39ed" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub><mo>…</mo><msub><mi>b</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">b_1\dots b_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> are words that coöccur</li></ul><ul id="10b2e7d3-01e5-80d2-915c-f675dea4f334" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">c_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> is the # of times <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(a,b_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> coöccur</li></ul></div></p><p id="10b2e7d3-01e5-8019-8a45-f064155e6b32" class=""><strong>Reducer:  </strong><div class="indented"><p id="10b2e7d3-01e5-8071-a5f9-c734d839e691" class="">Merge maps by summing the counts for shared keys.</p><p id="10b2e7d3-01e5-80da-be95-f61194774653" class=""><strong>Note: </strong>In this case the reducer function can also serve as the combiner.</p></div></p><h3 id="10b2e7d3-01e5-80cd-8faa-f97c2abdb8a3" class=""><strong>PseudoCode</strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-8005-acd3-ed9330baeb6b" class="code"><code class="language-Python">def map(key: Long, value: String):
	for u in tokenize(value)
		counts = {}
		for each v that coöcurs with u in value:
			counts(v) += 1 emit(u, counts)

def reduce(key: Long, values: List[Map[String-&gt;Int]]):
	for value in values:
		sum += value emit(key, sum)</code></pre><p id="7f7d1b57-02e5-47b6-a919-27a0b0b70df0" class="">Here, adding 2 Maps means taking the union of the keys, and setting the value to be the sum of the two values if it occurs in both Maps, otherwise taking the value from the single map that has it.  You MIGHT need to write that code yourself, but that’s what puts the pseudo in pseudocode</p><h3 id="9275e0a9-68e3-4896-921c-99de46c56302" class="">Analysis</h3><ul id="10b2e7d3-01e5-8064-bf20-f8e42dcf6fac" class="bulleted-list"><li style="list-style-type:disc"><strong>Fewer KVPs, but same # bytes</strong>: same shuffle load.</li></ul><ul id="10b2e7d3-01e5-80ee-9887-f1dea8d4ac2c" class="bulleted-list"><li style="list-style-type:disc"><strong>Combiner effectiveness</strong>: Higher, as it can merge co-occurrences before shuffling.</li></ul><ul id="f958ba5b-1976-404f-9ad1-b3df996e8617" class="bulleted-list"><li style="list-style-type:disc"><strong>Tradeoff</strong>: Map objects are LARGE and merging is more CPU-intensive, but reduced shuffle size can lead to a net gain.</li></ul></div></details><h3 id="10b2e7d3-01e5-803d-8457-c5d63c68655b" class=""><strong>Which to Use?</strong></h3><ul id="10b2e7d3-01e5-803f-b18c-fa9a806b3f8b" class="bulleted-list"><li style="list-style-type:disc"><strong>Stripes are generally faster</strong>, especially if memory allows.</li></ul><ul id="10b2e7d3-01e5-8083-9f9b-f472d36f8630" class="bulleted-list"><li style="list-style-type:disc"><strong>Pairs</strong> are better when memory is constrained or if distribution of co-occurrences is uniform (where stripes would use excessive memory).</li></ul></div></details><hr id="10b2e7d3-01e5-809f-96ab-fa85c5967452"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0"><strong>Relative Frequencies</strong></summary><div class="indented"><p id="10b2e7d3-01e5-80d7-930f-d8c54ec684e3" class="">We aim to calculate conditional probabilities like:</p><figure id="10b2e7d3-01e5-80ed-88f2-cc3b4f2d7fa2" class="equation"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><div class="equation-container"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>B</mi><mi mathvariant="normal">∣</mi><mi>A</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(B|A)=\frac{N(A,B)}{N(A, *)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∣</span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div></figure><p id="99adc7dd-f43e-4022-bfd1-af514f5009e0" class="">This measures how often <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span><span>﻿</span></span> <strong>follows</strong> <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span><span>﻿</span></span> in a given text.</p><h2 id="10b2e7d3-01e5-80e0-9a08-cd49707bd949" class=""><strong>Stripes Approach</strong></h2><p id="10b2e7d3-01e5-80c2-9c09-c2b380b36ccb" class="">The stripe for <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span><span>﻿</span></span> gives us all co-occurrences <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><msub><mi>B</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><msub><mi>B</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo></mrow><annotation encoding="application/x-tex">(A, B_1), (A, B_2), \dots</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span></span></span></span></span><span>﻿</span></span>, allowing direct computation of <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(A,*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> by summing the values for all <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">B_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10c2e7d3-01e5-801f-9eee-c22bb48d98ab" class="code"><code class="language-Python"># Gets the stripes from the text
def map(key: Long, value: String):
	stripes: map[str, map[str,float]] = HashMap()
	# CREATE THE STRIPES
	for word, prev in tokenize(value)
			if stripes.containsKey(prev):
					# UPDATE THE STRIPE
					stripe = stripes[prev]
					if stripe.containsKey(word):
							stripe[word] += 1
					else:
							stripe[word] = 1
			else:
					# CREATE A NEW STRIPE
					new_stripe = map({word: 1});
					stripes[prev] = new_stripe
	for key, value in stripes.items():
			emit(key, value)

	def Reduce(key: string, values: Stripe):
			m: map[str, float] = {};
			sum = 0
			for key, val in values:
					sum += val
			# now we have the total occurences of A
			# Compute relative frequencies
			for key, val in values:
					m[key] = (val / sum)
			# done
			emit(key, map)</code></pre><h2 id="10b2e7d3-01e5-801d-ad44-edd95c8aca9e" class=""><strong>Pairs Approach</strong></h2><p id="10b2e7d3-01e5-8045-aa42-fb7e77e546f9" class=""><strong>Problem </strong><div class="indented"><p id="10b2e7d3-01e5-800c-a04e-cd1d658bfee9" class="">In the pairs approach, we need to compute <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(A,*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> before calculating<link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>B</mi><mi mathvariant="normal">∣</mi><mi>A</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(B|A)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∣</span><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> for each <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span><span>﻿</span></span> that pairs with <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span><span>﻿</span></span>. </p><p id="10c2e7d3-01e5-80f0-a501-fb8fe51a17a5" class="">But in <em>MapReduce</em>, each pair <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> is processed independently, so <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(A,*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> isn&#x27;t available when processing individual pairs.</p></div></p><h3 id="10b2e7d3-01e5-802e-a14e-f00ebce8b09b" class=""><strong>Solution</strong></h3><ol type="1" id="008e090d-185d-4dca-9a60-1e489c6a8306" class="numbered-list" start="1"><li>Emit both <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> and <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A, *)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> from the mapper.<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-8050-a0d3-f7105e433491" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def map(key: Long, value: String):
    for u in tokenize(value):
        for v in cooccurrence(u):             # For each co-occurring pair
            emit((u, v), 1)                   # ((A,B), 1)
        emit((u, &quot;*&quot;), len(cooccurrence(u)))  # ((A,*), # co-occurences)</code></pre></li></ol><ol type="1" id="04e3e344-87a9-4c5c-a11c-d7e889d2c23d" class="numbered-list" start="2"><li>Use a <strong>partitioner</strong> to ensure all pairs for a given <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></span><span>﻿</span></span> (including <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A,*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> go to the same reducer.<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="db9675d3-d5e1-4ad4-839d-bc06b629657a" class="code"><code class="language-Python">def partition(key: Pair[String], value: Int, N: Int):
    return hash(key.left) % N  # Ensure all keys with the same first word go to the same reducer</code></pre></li></ol><ol type="1" id="b5680151-fd59-41cf-affa-a1d70b877311" class="numbered-list" start="3"><li>Use a <strong>sort order</strong> to ensure <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mo>∗</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A, *)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∗</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> is processed before <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> in the reducer: <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10b2e7d3-01e5-8034-ba22-df5ac0ad5b10" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">marginal = 0     # (in Java, a static field in class)
def reduce(key: Pair[String], values: List[Int]):
    let (a, b) = key
    sum = sum(values)

    if b == &quot;*&quot;:
		    # assuming the sort order, this runs first
        marginal = sum    # Store total occurrences of A
    else:
        # assuming the sort order, this runs last.
        emit((b, a), sum / marginal)  # Calculate relative frequency f(B|A)</code></pre></li></ol><h3 id="2adb4d84-e78f-45f2-90f5-0d870659d0aa" class=""><strong>Considerations</strong></h3><ol type="1" id="84007c78-bb90-4cce-95cc-b85df5aca6c5" class="numbered-list" start="1"><li><strong>Multiple Reducers</strong>: The partitioner ensures <strong>all pairs for a given word go to the same reducer</strong>, preventing inconsistent states.</li></ol><ol type="1" id="89597495-9dc1-4daf-a522-596e1d71ee07" class="numbered-list" start="2"><li><strong>Memory</strong>: The marginal variable in the reducer holds state across different KVPs for the same word, making this approach scalable.</li></ol></div></details><hr id="10b2e7d3-01e5-8029-b705-eff14867c2af"/><details open=""><summary style="font-weight:600;font-size:1.875em;line-height:1.3;margin:0">Pairwise Mutual Information </summary><div class="indented"><p id="c1c2ae6f-cd8d-4a36-a4c3-3bb349451e8b" class="">The formula for PMI is:</p><figure id="10b2e7d3-01e5-80ee-b1fe-e87cc1c94167" class="equation"><link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><div class="equation-container"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>M</mi><mi>I</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mfrac><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">PMI(x,y)=\log\frac{p(x,y)}{p(x)p(y)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">PM</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div></figure><h3 id="bb23e245-98d9-47d1-a6bb-9042bae358b5" class=""><strong>Why Use PMI?</strong></h3><ul id="fc534b9d-ccd7-433e-acc6-52c33920e522" class="bulleted-list"><li style="list-style-type:disc">Tokens with similar co-occurrence patterns (high PMI) likely have similar meanings, making PMI a useful measure in natural language processing.</li></ul><h3 id="f67b6d6d-3ed3-4b1f-8436-e5b5539f668e" class=""><strong>Requirements for Calculation</strong></h3><ul id="797f38ba-bb8d-4072-b186-9d98d20f82e8" class="bulleted-list"><li style="list-style-type:disc">To compute PMI, we need the joint probability <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> and the individual probabilities <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> and <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span></li></ul><ul id="130a1f17-db17-4dc9-b816-f5b78c9da467" class="bulleted-list"><li style="list-style-type:disc">This requires <strong>2 MapReduce tasks</strong> because the pairs and stripes methods don&#x27;t directly provide <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> and <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> for the same reducer processing <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x,y) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span></li></ul><h3 id="1a51c455-650a-4287-a7b8-911307ae9387" class=""><strong>Two-Pass Approach</strong></h3><ol type="1" id="f45a4c4d-cb12-4df3-873a-1df59c06d7a6" class="numbered-list" start="1"><li><strong>Pass 1</strong>: Modified word count<ul id="b6b87bdb-37b4-4c9e-8c82-8847906b2991" class="bulleted-list"><li style="list-style-type:disc">Count the number of lines containing each token (instead of the total occurrences). </li></ul><ul id="cf9465ef-0493-4df9-8fdf-f6179e5b331e" class="bulleted-list"><li style="list-style-type:disc">This provides <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> and <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span>. </li></ul></li></ol><ol type="1" id="e7dd3168-04ff-41d5-a6c6-001d7d3b8d1d" class="numbered-list" start="2"><li><strong>Pass 2</strong>: Compute PMI<ul id="d3eaa9d1-e57e-4827-92c6-2e60ded898d9" class="bulleted-list"><li style="list-style-type:disc">The reducer needs access to <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>∗</mo></mrow><annotation encoding="application/x-tex">A*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord">∗</span></span></span></span></span><span>﻿</span></span> and <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>∗</mo></mrow><annotation encoding="application/x-tex">B*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∗</span></span></span></span></span><span>﻿</span></span> (marginal counts).</li></ul><ul id="bec5ffaf-2f2a-4207-af67-b364cb673256" class="bulleted-list"><li style="list-style-type:disc">Load results from Pass 1 in the reducer&#x27;s setup method and store them in a hash table (Java Map object)</li></ul></li></ol><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><strong>Implementation Details</strong></summary><div class="indented"><p id="10b2e7d3-01e5-80b1-a973-d87c7896f9f4" class="">This structured approach allows for efficient calculation of PMI while ensuring all necessary data is available during the computation. </p><ul id="368328d7-56b2-4614-b57f-1c0c386142e2" class="bulleted-list"><li style="list-style-type:disc"><strong>Avoid Pairwise Issues</strong>: The stars must be emitted as <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∗</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">*A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∗</span><span class="mord mathnormal">A</span></span></span></span></span><span>﻿</span></span> and <link rel="stylesheet" type="text/css" href="../../notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∗</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">*B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span><span>﻿</span></span> to ensure they sort before all occurrences of A and B. This guarantees that when processing pairs in the reducer, the marginal counts for A and B are available.</li></ul><ul id="10b2e7d3-01e5-8022-8dd2-f74c0d076636" class="bulleted-list"><li style="list-style-type:disc"><strong>Challenges: </strong>The issue of *A and *B not being on the same reducer and the sorting order complicates the process. By ensuring the stars precede all occurrences in sorting, we can consolidate the marginal counts effectively.</li></ul><p id="60afe15a-61c6-41fc-83fc-1c7b5f87b1fd" class=""><strong>Example Mapper Emission</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="be966533-0836-4859-a70e-0c2bac00d0d4" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def map(key: Long, value: String):
    for token in tokenize(value):
        emit((token, &quot;*&quot;), 1)              # Emit marginal count
        for other_token in cooccurrence(token):
            emit((token, other_token), 1)  # Emit co-occurrence</code></pre><p id="b8ce3654-397e-4d3d-bc1d-9fcad4fe4226" class=""><strong>Reducer</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="386533f7-a3aa-433c-a918-f68fc0651f78" class="code"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">hash_table = {}  # Hash table to store marginal counts

def setup():
    # Load marginal counts from pass 1 results into hash_table
    ...

def reduce(key: Pair[String], values: List[Int]):
    let (x, y) = key
    # Load marginal counts from hash_table and calculate PMI
    if y == &quot;*&quot;:
        # Store marginal counts for x
        hash_table[x] = sum(values)
    else:
        # Compute PMI using values and hash_table for marginal counts
        pmi = log(sum(values) / (hash_table[x] * hash_table[y]))
        emit((x, y), pmi)</code></pre></div></details><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0"><strong>As a Single Job </strong></summary><div class="indented"><p id="10b2e7d3-01e5-802f-b2f0-e413446d5533" class="">instead of 1 job collecting how many lines each word is on, + another for doing pairs/stripes for co-occurence counting, 1 job does both and shuffle at same time. But, this does not save any time. </p><p id="6022c4ff-ec31-4bc3-b7c7-02e6d8b3d9e1" class=""><strong>Pairs: </strong></p><p id="10b2e7d3-01e5-8062-8c8b-c6638e79e590" class="">If you have 3 reducers </p><p id="421ebe3c-df59-4970-9aa1-c4fbb953a1e9" class="">(*0, A), (*1, A), (*2, A)</p><ul id="10b2e7d3-01e5-807e-92d2-e439d03a08d1" class="bulleted-list"><li style="list-style-type:disc">we don’t care that A, b1 and A, b2 end up in same spot. </li></ul><ul id="10b2e7d3-01e5-80f8-9606-c8992c3f28a4" class="bulleted-list"><li style="list-style-type:disc">if key starts with “*”, __ the start off, parse it as an integer and send it to that reducer. </li></ul><ul id="10b2e7d3-01e5-8042-84fd-ee6093614241" class="bulleted-list"><li style="list-style-type:disc">for this to happen, mappers need to know of 3 reducers. <ul id="10b2e7d3-01e5-80c1-8d22-d705d549b1f2" class="bulleted-list"><li style="list-style-type:circle">you can use <code>config.setInteger(numReducers: 3/5/...)</code></li></ul><ul id="f3d8ce24-04d3-47db-8e8e-ba5586f3a52f" class="bulleted-list"><li style="list-style-type:circle">good place to put line count for second pass</li></ul><ul id="10b2e7d3-01e5-80e9-9938-e593a43d92c3" class="bulleted-list"><li style="list-style-type:circle">now it knows it will admit *0, *1, *2 for each word<ul id="10b2e7d3-01e5-80a1-ae86-e12987b76dc5" class="bulleted-list"><li style="list-style-type:square">each reducer gets full sum for each word. </li></ul><ul id="10b2e7d3-01e5-8072-afa7-c922875e081e" class="bulleted-list"><li style="list-style-type:square">when pairs arrive, they can be sorted</li></ul></li></ul></li></ul><p id="10b2e7d3-01e5-8028-b42a-d7734c7f026a" class=""><strong>Stripes: </strong></p><ul id="fea7f4e2-266d-4667-aba4-b036747b3ed6" class="bulleted-list"><li style="list-style-type:disc">Similar, do a *0 and then a full stripe representing all the word counts for each individual one. </li></ul><ul id="9dcefd40-9bdd-4e06-bc9d-274cabd04101" class="bulleted-list"><li style="list-style-type:disc">Send to each reducer, not just one. </li></ul><p id="af8a92a0-7949-45bc-8f4b-91fc472ac721" class="">
</p></div></details></div></details><p id="10b2e7d3-01e5-80cb-84a9-c5f9e38e1c2c" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"><hr/><details open="" style="padding-top:1em"><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0">Inline comments</summary><div class="indented"><div><ul class="toggle"><li><div><span class="user" style="padding:0.2em"><img src="https://lh3.googleusercontent.com/a/ALm5wu2D7opyGPhg1IC5ZBqM5ZYIOR8MwAIakj3yS20lKw=s100" class="icon user-icon"/><span><b>roman hudaj</b> <time style="font-size:0.8em">Sep 23, 2024, 8:44 PM</time></span></span></div><div style="padding:0.2em"><br/>• $N(A,B)$  is the number of coöccurrences of $A$ and $B$<br/>• $N(A,*)$ is the sum of $N(A,x)$ over all $x$<br/></div><div style="padding:0.3em"></div></li></ul></div><hr/></div><div class="indented"><div><p style="padding:0.2em"><b>Block text</b>: <mark class="highlight-yellow_background">coöccurs</mark></p><ul class="toggle"><li><div><span class="user" style="padding:0.2em"><img src="https://lh3.googleusercontent.com/a/ALm5wu2D7opyGPhg1IC5ZBqM5ZYIOR8MwAIakj3yS20lKw=s100" class="icon user-icon"/><span><b>roman hudaj</b> <time style="font-size:0.8em">Sep 23, 2024, 8:23 PM</time></span></span></div><div style="padding:0.2em">we can pick whatever definition of cooccurrence we want…it might just mean “is at the next index”. </div><div style="padding:0.3em"></div></li></ul></div><hr/></div></details></span></body></html>