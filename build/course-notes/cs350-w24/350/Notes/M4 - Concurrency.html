<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>M4 - Concurrency</title><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/></head><body><article id="bc6191d3-889d-474b-998e-7e6297470d30" class="page sans"><header><div class="page-header-icon undefined"><img class="icon" src="https://www.notion.so/icons/document_purple.svg"/></div><h1 class="page-title">M4 - Concurrency</h1><p class="page-description"></p></header><div class="page-body"><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="cf315c18-c1b8-4e71-b77f-f5482a7d5b12"><div style="font-size:1.5em"><span class="icon">‚ùó</span></div><div style="width:100%"><mark class="highlight-red"><strong>Critical Section</strong></mark><hr id="f2a6a7b5-d033-4611-b2ed-d534d7e3c2ce"/><p id="5150ec1a-15c0-486b-b0ce-7847867b0a34" class="">Part of the concurrent program in which a <span style="border-bottom:0.05em solid"><em>shared object</em></span><em> </em><mark class="highlight-gray"><em>(variable or heap object)</em></mark><em> </em>is accessed by separate <mark class="highlight-gray"><em>(concurrent) </em></mark>threads. </p></div></figure><h3 id="080e2afa-94e7-44fa-9c0a-273483227b4d" class=""><mark class="highlight-purple"><strong>Motivating - Problem</strong></mark></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9b87f904-9c34-4be5-9e29-bbffde43a67e" class="code"><code class="language-C">int total = 0; //shared object</code></pre><div id="12b8d52a-9fea-41b0-b2c2-cdc35ee65451" class="column-list"><div id="d02aa037-e4c7-4586-afdf-3fa50b225c8c" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7411b9bb-f2c8-4d4a-bc1f-1a9e9554287d" class="code"><code class="language-C">// Thread 1
void add() {
	total++;
	/*  lw r9, 0(r8)
			add r9, 1
			sw r9, 0(r8) */
}</code></pre></div><div id="76c530b2-0247-42a7-b9f2-34f5860ac45d" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9beff23c-2376-4433-9f74-17e20d749f64" class="code"><code class="language-C">// Thread 2
void sub() {
	total--;
	/*  lw r9, 0(r8)
			sub r9, 1
			sw r9, 0(r8) */
}</code></pre></div></div><ul id="9e84f557-9719-4b52-9bad-1d560772b213" class="toggle"><li><details open=""><summary><strong>Schedule 1 </strong></summary><p id="ce75ad54-eedd-489a-9945-64596bc78537" class="">Total = 0 </p><table id="841b3063-e39a-466e-ae88-3be1f074e5dd" class="simple-table"><tbody><tr id="ba59ca1e-ade7-4fd5-b055-a5c71864e04a"><td id="U[l\" class="block-color-red">lw r9, 0(r8)</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="cd0279f7-d309-4392-bf1f-7c591c677444"><td id="U[l\" class="block-color-red">add r9, 1</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="4c61910a-336a-4d48-85f0-7ff9ac3b6c1d"><td id="U[l\" class="block-color-red">sw r9, 1</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="434b247a-721e-4133-8a9f-b3c568a1681f"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">lw r9, 0(r8)</td></tr><tr id="65819db5-0890-4df6-ac85-671f79edb774"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">sub r9, 1</td></tr><tr id="1ccdb7f1-e252-4703-9247-cac8990d6fb9"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">sw r9, 1</td></tr></tbody></table></details></li></ul><ul id="6448b2aa-6c2d-43ba-a85d-3e91c6cd5ae6" class="toggle"><li><details open=""><summary><strong>Schedule 2</strong></summary><p id="86d08870-9f08-460e-888d-d9bc49daa4d8" class="">Total = -1 </p><table id="0c4c59f0-2c56-4b2f-9379-3b7635621c67" class="simple-table"><tbody><tr id="773d631c-5704-492f-b6c5-f78885ace9e7"><td id="U[l\" class="block-color-red">lw r9, 0(r8)</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="cc0c1c46-32ea-4b6f-8307-b9864203b0c7"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">lw r9, 0(r8)</td></tr><tr id="bc8f22a0-5d39-4ea8-b6b5-5f1e00e5235e"><td id="U[l\" class="block-color-red">add r9, 1</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="057f401b-a9fe-4f2a-a467-c7a12abd1e60"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">sub r9, 1</td></tr><tr id="bbb33649-40cc-4c2f-abab-fe7e6efe10a9"><td id="U[l\" class="block-color-red">sw r9, 1</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="d16d83e5-ae08-40e6-8e71-0a48cb347284"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">sw r9, 1</td></tr></tbody></table></details></li></ul><ul id="dbcc734d-cb78-4de1-b45e-8919a6da1c50" class="toggle"><li><details open=""><summary><strong>Schedule 3</strong></summary><p id="739818ae-0d86-42f9-9906-dfbb6c01ac6c" class="">Total = 1</p><table id="62ac10ac-7ffb-4441-9472-e58e3cc32b98" class="simple-table"><tbody><tr id="76350e77-ed8a-4726-b105-9a75b58b5c57"><td id="U[l\" class="block-color-red">lw r9, 0(r8)</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="b7401cc6-17e9-49c6-9dc0-2691ac3dbeed"><td id="U[l\" class="block-color-red">add r9, 1</td><td id="d@[p" class="block-color-blue"></td></tr><tr id="de379ce4-94ef-4d83-9f03-fdd67768a3b1"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">lw r9, 0(r8)</td></tr><tr id="3c5e2530-a8d4-47bd-a46e-66df09f9cba1"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">sub r9, 1</td></tr><tr id="076476ed-f921-4217-b193-037bbd9f087c"><td id="U[l\" class="block-color-red"></td><td id="d@[p" class="block-color-blue">sw r9, 1</td></tr><tr id="7ac9f14d-904c-4578-a745-b393537a0e77"><td id="U[l\" class="block-color-red">sw r9, 1</td><td id="d@[p" class="block-color-blue"></td></tr></tbody></table></details></li></ul><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="18630ac3-15de-4ed1-a44b-2b23960ebbcd"><div style="font-size:1.5em"><span class="icon">‚ùó</span></div><div style="width:100%"><mark class="highlight-red"><em><strong>Data Races</strong></em></mark><strong> </strong>occur w‚Äôout <mark class="highlight-red"><em><strong>Synchronization</strong></em></mark><p id="336f2753-3b40-4e01-8865-1e9d9d4cf615" class=""><strong>synchronization</strong> is needed for parallel processes in a system. </p><p id="8df19b06-fe07-4e30-959e-055b2137549a" class="">Modifiying variables at the <em>program level </em>requires multiple <em>machine code </em>instructions. For shared objects, we want these instructions to execute <strong>atomically</strong></p><p id="7aae9a9d-1930-423c-ac09-e1dc17f6e143" class=""><strong>Options</strong></p><ol type="1" id="7ee79996-e5f5-447f-b80b-09132a541fe0" class="numbered-list" start="1"><li>Atomic Instructions <mark class="highlight-gray"><em>(kernel-level) </em></mark><ul id="48b2e1f2-7b7f-45af-8690-b6b901f4364e" class="bulleted-list"><li style="list-style-type:disc">modify values instantaneously</li></ul><ul id="314763d9-a145-4502-8693-90e0e3b277c6" class="bulleted-list"><li style="list-style-type:disc">prevent the need for <strong>synchronization</strong></li></ul></li></ol><ol type="1" id="a6cd68ff-8e0d-4059-9e95-c559b1e6c600" class="numbered-list" start="2"><li>Locks <mark class="highlight-gray"><em>(user level) </em></mark><ul id="9eb54949-626a-4b93-8405-8fe10237a466" class="bulleted-list"><li style="list-style-type:disc">primitives to add barieiers; provide <strong><em>synchronization</em></strong></li></ul><ul id="c812dbd2-79b0-420f-a5d8-7b7fb0bdeda7" class="bulleted-list"><li style="list-style-type:disc">prevents concurrent execution</li></ul></li></ol><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="5f784f18-697b-4b96-9cf1-54758d785939"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%">As we will see, <em>(1) Atomic Instructions </em>can‚Äôt solve all problems alone. Using <em>Locks</em>, at the <em>user-level</em>, will help us solve all our problems. </div></figure></div></figure><h2 id="1f51f0a4-0a7b-4149-8e51-10eacc794234" class=""><mark class="highlight-red">Desired Solution Properties</mark></h2><ol type="1" id="ad8d3a27-3b2c-4437-98c9-9d0f380e16c6" class="numbered-list" start="1"><li><mark class="highlight-red"><strong>Mutual Exclusion</strong></mark><ul id="c09823bb-63d5-4e99-b5a2-b30dc8e356b1" class="bulleted-list"><li style="list-style-type:disc">Only 1 thread can ‚Äúbe in‚Äù the critical section at once</li></ul><ul id="a0502c7d-eb20-431d-9463-031b1a3f173c" class="bulleted-list"><li style="list-style-type:disc">Mutual Exclusion on a <span style="border-bottom:0.05em solid"><em>critical section</em></span><em> ‚áí no</em> <span style="border-bottom:0.05em solid"><em>race conditions</em></span><em> </em></li></ul></li></ol><ol type="1" id="7e2c3224-2cd5-4965-aa28-ee1fbc2f2019" class="numbered-list" start="2"><li><mark class="highlight-red"><strong>Progress</strong></mark><p id="a37ccc92-ee1f-4c70-bfab-964e04b97c88" class="">No thread is inside the CS ‚áí some thread will eventually get in</p></li></ol><ol type="1" id="9eb9acfc-d733-47d6-840a-3fe956d03a77" class="numbered-list" start="3"><li><mark class="highlight-red"><strong>Bounded Waiting </strong></mark><p id="5c89b5dd-1dc5-4cd3-9c29-ebf970da43cc" class="">There is a bound on how long a thread can wait to enter; i.e., no thread can keep getting in. </p></li></ol><p id="3796966a-cfde-4562-9d6e-220a4ee29b06" class=""><strong>But</strong>, a solution could provide all of these, yet still not work without <strong>sequential consistency</strong>.  </p><h2 id="1e2db8fe-c6a1-4023-9b4b-19fdf5dcad98" class="block-color-red">Sequential Consistency</h2><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="5686cda7-7ccb-4f90-a7d0-24ba73287197"><div style="font-size:1.5em"><span class="icon">‚ùó</span></div><div style="width:100%"><mark class="highlight-red"><strong>Sequential Consistency</strong></mark><hr id="be206e90-c2d1-4b35-94bb-5b2ce8071095"/><p id="8bcab3f5-33e6-4ac0-a611-387825c11a70" class="">Guarantees 2 things: </p><ul id="b8af3476-e0d5-44c4-b413-9850a828e5f2" class="block-color-default toggle"><li><details open=""><summary><strong>1 ‚Äî </strong>Individual processors ensure <strong>program order</strong></summary><p id="0528a0ec-f600-4726-9ac0-33eeecd1f8be" class=""><em>The order of instructions (of a program running on a thread) you execute on a single core is in the same sequential order. We don‚Äôt know the relative order of instructions between cores. </em></p></details></li></ul><ul id="1f7a4f77-02f6-4d2c-b01a-93727042763b" class="block-color-default toggle"><li><details open=""><summary><strong>2 ‚Äî</strong> Ensuring <strong><em>write atomicity</em></strong></summary><p id="f7091d26-0256-4a60-9e33-8fe5fa3e22ae" class=""><em>A write (which involves load &amp; store) is fully completed on one thread before another thread can access the same object. </em></p><ul id="2a8370a1-4508-4d9d-8205-4d0a99dd2682" class="toggle"><li><details open=""><summary><em>Example</em></summary><p id="361082e0-5d29-4c3b-bb05-00d485fb24cb" class=""><em>If your writing to an 4 byte integer and it writes 2 bytes at a time, another thread on another processor can‚Äôt read the intermediate results; it either sees all of the writes, or none at all. </em></p></details></li></ul></details></li></ul><hr id="e53aba34-fb05-407b-89ee-1c757d3a49d3"/><ul id="88ef821c-b6bf-4e60-99e1-2991c525be1a" class="toggle"><li><details open=""><summary><mark class="highlight-purple"><strong>Examples</strong></mark></summary><ul id="94ce3836-57a5-496a-b100-5db83b57e253" class="toggle"><li><details open=""><summary><strong>Program A</strong></summary><p id="bd1cf29a-6669-4fcd-af4c-3e21cb5e3ff4" class=""><strong>Q: </strong>(<em>progress </em>property) can both critical sections run ? </p><p id="132b360c-e180-4713-86f3-6b2c5d7fce8c" class="">‚Üí it‚Äôs possible that one or neither of them run (depends on the order of instructions)</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2b09603f-35af-4318-92e5-0a898ad2da49" class="code"><code class="language-C" style="white-space:pre-wrap;word-break:break-all">int flagl = 0, flag2 = 0;</code></pre><div id="bf4059d1-2765-40ec-9453-62de170c0f6b" class="column-list"><div id="f31ca3b5-0c9f-4050-9b12-bdb86ac4a4fd" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="737a0bd5-8b33-4ed7-8c2e-bf61f91405e0" class="code"><code class="language-C">void p1(void *ignored) {
	flag1 = 1;
	if (!flag2) {
		critical_section_1();
	}
}</code></pre></div><div id="2a9911f8-25e5-4844-9b9b-433c721d84ee" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e68acc45-93b3-4763-ae93-6d3e614adcd5" class="code"><code class="language-C">void p2(void *ignored) {
	flag2 = 1;
	if (!flag1) {
		critical_section_2();
	}
}</code></pre></div></div></details></li></ul><ul id="d89873b0-61e5-4bf4-a562-c63406aa3342" class="toggle"><li><details open=""><summary><strong>Program B</strong></summary><p id="a6505de6-0668-4341-8e3c-4b9d7caa70fd" class=""><strong>Q: </strong>can <mark class="highlight-default"><code>use(data)</code></mark> be called with <code><mark class="highlight-default">data = 0</mark></code><mark class="highlight-default"> </mark>?</p><ul id="7f1c936c-dd36-4968-b112-0d22aef9dc46" class="bulleted-list"><li style="list-style-type:disc">can reorder instructions ‚Üí no</li></ul><ul id="737928aa-72d2-4314-a4f5-8a4ab4ae7f1e" class="bulleted-list"><li style="list-style-type:disc">otherwise ‚Üí yes </li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2830fe70-8f7b-4694-ae82-874f64e24ba6" class="code"><code class="language-C" style="white-space:pre-wrap;word-break:break-all">int data = 0, ready = 0;</code></pre><div id="ce452144-5eca-4cb3-a483-4826bca0a956" class="column-list"><div id="fe35e591-957a-452e-b88b-946fb435c39e" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="32c9e858-52f3-4ae8-9d79-6477e3882208" class="code"><code class="language-C">void p1(void *ignored) {
	data = 2000;
	ready = 1;
}</code></pre></div><div id="ef59201d-a127-45bb-8559-e3076f8c1c79" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b61528be-fdc7-4dc0-8a71-14fd7eb34e38" class="code"><code class="language-C">void p2(void *ignored) {
	while(!ready);
	use(data);
}</code></pre></div></div></details></li></ul><ul id="d2725e06-ed51-44cf-b19d-35283b19973b" class="toggle"><li><details open=""><summary><strong>Program C</strong></summary><p id="2a7d7973-ff01-475e-9e34-6522a908aedc" class=""><strong>Q: </strong>can <mark class="highlight-default"><code>use(a)</code></mark> be called with <code><mark class="highlight-default">a=0</mark></code><mark class="highlight-default"> ?</mark></p><ul id="571bd672-1098-4264-924c-7c770332df15" class="bulleted-list"><li style="list-style-type:disc">can reorder instructions ‚Üí no</li></ul><ul id="9a99e8d9-f49f-4615-9d43-4287f8090394" class="bulleted-list"><li style="list-style-type:disc">otherwise ‚Üí yes </li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7ed21684-c609-47a5-a8ed-983f6b3942fa" class="code"><code class="language-C" style="white-space:pre-wrap;word-break:break-all">int a = 0, b = 0;</code></pre><div id="ade4906d-8a14-482c-bc01-e08dcd26537d" class="column-list"><div id="06d7a213-40ea-4598-adb5-4c3b267b6088" style="width:33.33333333333333%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="33f8d318-fd22-4ff4-8ff3-00f9b867149b" class="code"><code class="language-C">void p1(void *ignored) {
	a = 1;
}
</code></pre></div><div id="4b4318d0-984f-4e4c-b52f-28b3c8d3875b" style="width:33.33333333333333%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="de93c467-c68c-4549-aed3-9fd81981f8cf" class="code"><code class="language-C">void p2(void *ignored) {
	if (a == 1) b = 1;
}</code></pre></div><div id="b5d22767-425f-4ce2-a0c4-3be485b96325" style="width:33.33333333333333%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="dd2fee36-1265-4257-a23b-ce9a5cf90ff0" class="code"><code class="language-C">void p2(void *ignored) {
	if (b == 1) use(a);
}</code></pre></div></div></details></li></ul><p id="5562c843-ec4e-44b7-b83a-35fc7b53c0bd" class="">The answers to the <mark class="highlight-purple">questions</mark> depend on what machine you use. </p><p id="5a9121d0-27ae-42c2-b4ca-679cd5001af0" class="">If the system provides <strong>S.C </strong>‚Üí<strong> </strong>NO to all </p></details></li></ul><hr id="ac353e42-bd17-4c25-89e5-41fde93b9885"/><p id="0215888e-cd88-4a0a-a82e-408feb9b52e7" class="">Most CPUs don&#x27;t provide sequential consistency because weak-memory models have better performance. But, they dangerously allow load/store operations to be reordered.</p></div></figure><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0"><strong>Optimizations Prevented by SC</strong></summary><div class="indented"><p id="72102fe9-c419-4f99-bef5-82b50fb91d36" class=""><strong>Re-Order Overlapping writes</strong></p><ul id="71f92086-c79c-4cee-9cf1-06ffd491c35e" class="bulleted-list"><li style="list-style-type:disc">If 2 write operations (diff threads) are to the same memory, you can re-order them to improve performance if you don‚Äôt need SC. </li></ul><p id="d9134507-d78a-4260-9fab-9bcd25c928d6" class=""><strong>Data Prefetching</strong></p><ul id="e0203885-9577-404b-8ad6-985a6ad9a690" class="bulleted-list"><li style="list-style-type:disc">save data that will be used later</li></ul><ul id="fdfddd45-0d9f-4cef-870d-2a12e1628982" class="bulleted-list"><li style="list-style-type:disc">SC will more likely invalidate this prefetched data. </li></ul><p id="a99b9b75-3f87-4217-a704-556819beba1a" class=""><strong>Cache Coherence</strong></p><ul id="70634c16-1c20-4adb-ad99-f66e48d82155" class="bulleted-list"><li style="list-style-type:disc">With a weaker consistency model, we don‚Äôt need to check cache for each processor, so the <em>cache coherence protocol </em>will be faster. </li></ul><p id="70ddcd72-5fb3-4a6c-99e0-ed9f8eadf948" class=""><strong>Caching value in register</strong></p><ul id="57a1ec04-33ab-4b6e-a3c9-d0a9414f8f32" class="bulleted-list"><li style="list-style-type:disc">combine multiple loads/stores of same address into 1 operation</li></ul><p id="e3f20401-4c19-4819-b298-c238b5085eeb" class=""><strong>Common subexpression elimination </strong></p><ul id="b0fd3520-d24a-43e5-8677-9ebb473b9354" class="bulleted-list"><li style="list-style-type:disc">could cause memory location to be read few times</li></ul><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="7619cfec-e56c-4265-90b0-58ee563c767b"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%"><strong>Cache Coherence Protocol</strong><ul id="9e910dc5-4f6c-4528-b5db-252b9257a2ea" class="bulleted-list"><li style="list-style-type:disc">Each cores has it‚Äôs own local cache. </li></ul><ul id="6a75b2c3-3e3f-48c6-8a44-6eaed217f924" class="bulleted-list"><li style="list-style-type:disc">We need the caches to be consistent w‚Äô each other and w‚Äô main memory</li></ul><ul id="f3e9e6bd-ed71-4bf8-bdc6-aff600ecbb39" class="bulleted-list"><li style="list-style-type:disc">To ensure <strong>cache coherence</strong>, the cores need to check if stuff in it‚Äôs own cache has been written to. </li></ul><hr id="dd16ec4c-5575-4497-9427-736d408a881f"/><ul id="30faded0-e5e8-43c1-b482-0ad02c69b825" class="toggle"><li><details open=""><summary><mark class="highlight-purple"><strong>Example</strong></mark></summary><p id="c7511f71-ed9c-42df-8f66-520e35dce2b6" class="">2 cores, each with their own cache, but they share the same main memory </p><ol type="1" id="0c2fe964-541c-4611-996a-eb9330345d05" class="numbered-list" start="1"><li><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">c_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> sets <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span>Ôªø</span></span><ol type="a" id="c5c0f597-0776-4062-9d24-2a01b6c175a9" class="numbered-list" start="1"><li>reads <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span><span>Ôªø</span></span> from memory </li></ol><ol type="a" id="3efbb0a7-0fdb-48d0-8917-b406b595a272" class="numbered-list" start="2"><li>stores in cache1</li></ol><ol type="a" id="670f9988-3c60-45e2-8ed6-ec6bd5be297e" class="numbered-list" start="3"><li>sets <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span>Ôªø</span></span> in memory</li></ol></li></ol><ol type="1" id="9600eadc-b0c7-4724-8477-2ae272a346a5" class="numbered-list" start="2"><li><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">c_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> sets <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span>Ôªø</span></span><ol type="a" id="ac4b4efd-c101-4f9c-b3cd-9d5135352f86" class="numbered-list" start="1"><li>reads <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span><span>Ôªø</span></span> (0) from  memory </li></ol><ol type="a" id="68541bc7-faa1-4fc8-bfbd-29ba28e0b2eb" class="numbered-list" start="2"><li>stores in cache2</li></ol><ol type="a" id="3108b1b6-65fb-4609-aa60-b36373401ce4" class="numbered-list" start="3"><li>sets <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span>Ôªø</span></span> in memory</li></ol></li></ol><p id="3487632a-6f52-4949-9e7f-49753c791399" class="">Problem: when <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">c_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> reads <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span><span>Ôªø</span></span> again, it‚Äôs in the cache, so it will be equal to <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span>Ôªø</span></span></p></details></li></ul></div></figure></div></details><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0">SC in x86</summary><div class="indented"><p id="4e6e0428-13a6-444e-8cb1-ef6cfdfe8a92" class=""><strong>Write Back Caching (default) </strong>write to cache instead of memory. Don‚Äôt flush to memory until it‚Äôs cleared from the cache. Faster, but make‚Äôs cache coherence harder. </p><p id="d043b302-f5de-4423-b326-5ba9c940499f" class=""><mark class="highlight-red">A </mark><mark class="highlight-red"><em>read</em></mark><mark class="highlight-red"> could finish before an earlier </mark><mark class="highlight-red"><em>write</em></mark><mark class="highlight-red"> to a different location </mark><mark class="highlight-gray"><em>(reading the old value)</em></mark></p></div></details><h1 id="e5a1ab53-f85e-4a30-82d4-88f1ecc9493d" class="">Finding a solution </h1><table id="fa6b7b63-2c44-45fb-bba0-22ed15ceeb2a" class="simple-table"><thead class="simple-table-header"><tr id="df856b1c-4c49-421f-b427-1be4b55dcbf0"><th id="YDi[" class="simple-table-header-color simple-table-header"></th><th id="cA;W" class="simple-table-header-color simple-table-header" style="width:292.9971466064453px"><mark class="highlight-red"><strong>Problem</strong></mark></th><th id="SK~?" class="simple-table-header-color simple-table-header">Notes</th></tr></thead><tbody><tr id="801af044-b723-4f98-b97c-21df8bb54684"><th id="YDi[" class="simple-table-header-color simple-table-header"><mark class="highlight-orange">Solution Attempt #1 </mark></th><td id="cA;W" class="" style="width:292.9971466064453px">The lock is not <em>checked</em> &amp; <em>set</em> atomically</td><td id="SK~?" class=""></td></tr><tr id="01e9cd19-4847-426b-8b45-2c5be75459cb"><th id="YDi[" class="simple-table-header-color simple-table-header"><mark class="highlight-orange">Peterson‚Äôs Solution </mark></th><td id="cA;W" class="" style="width:292.9971466064453px">1. Works for only 2 threads<br/>2. Requires Sequential consistency<br/></td><td id="SK~?" class=""></td></tr><tr id="5228f0ca-7e49-4c60-958e-66e3df9a3a18"><th id="YDi[" class="simple-table-header-color simple-table-header"><mark class="highlight-orange"><strong>Spinlocks</strong></mark></th><td id="cA;W" class="" style="width:292.9971466064453px">1. Wastefull </td><td id="SK~?" class="">Implemented with <mark class="highlight-default"><code><em>Xchg</em></code></mark></td></tr><tr id="b80ee539-cb34-4c31-bb8b-5b914219002c"><th id="YDi[" class="simple-table-header-color simple-table-header"></th><td id="cA;W" class="" style="width:292.9971466064453px"></td><td id="SK~?" class=""></td></tr></tbody></table><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><mark class="highlight-orange">Solution Attempt #1 </mark></summary><div class="indented"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6a970558-c3e1-4b57-b4d5-25889de2d6fc" class="code"><code class="language-C">int total = 0;        //shared object
bool lock = false; </code></pre><div id="df29d6f6-6d6c-4f94-9542-a473d57b6ea6" class="column-list"><div id="ffd5e6b4-40df-42c8-b80f-8c06e769bac2" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="25ae51e0-3eb8-45f0-aee5-341a4d84a30b" class="code"><code class="language-C">// Thread 1
void add() {
	while (lock == true);
// &lt;- T2 can set lock = true
	lock = true;
	total++;
// &lt;- total--;
	lock = false;
}</code></pre></div><div id="45d225eb-d15a-4c6e-b300-8ab0e313265b" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="42fefd8d-f756-4821-ae57-8412b43324af" class="code"><code class="language-C">// Thread 2
void sub() {
	while(lock == true);
	lock = true;
	total--;
	lock = false;
}</code></pre></div></div><h3 id="6a64a281-09ee-4de5-b0eb-65ece69386c0" class=""><mark class="highlight-red">Problem</mark> </h3><p id="4fb9c721-b6a7-4837-90b6-48fca1cab6f9" class="">Need to <em>check</em> &amp; <em>set</em> the lock at the same time</p><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="6da93e7b-24b4-4b5e-905b-0a7ba3722d59"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%">There‚Äôs no single <em>atomic instruction </em>to do this </div></figure></div></details><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><mark class="highlight-orange">Peterson‚Äôs Solution </mark></summary><div class="indented"><p id="1d269981-9e1c-448b-8416-f12c1f622a04" class="">Assume <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span><span>Ôªø</span></span> holds the current thread‚Äôs id (<link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span>Ôªø</span></span> or <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span>Ôªø</span></span>) </p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="daeb7a39-ff7f-4bd6-8013-0e5d0ae39701" class="code"><code class="language-C">int n_turn = 0;               // NOT 0&#x27;s turn
bool w[2] = {false, false};   // WANTS to enter CS
int total = 0;   </code></pre><p id="3a8cb0b7-d567-444c-bbff-bf8e5210697b" class="">Both Threads will look like this: </p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="47ab48e6-fb23-4a2c-bffa-21106e181f10" class="code"><code class="language-C">// Thread 0
void f() {
		w[t] = true;  // you want to enter
		n_turn = t;   // mark it as not your turn
		while (w[1-t] &amp;&amp; n_turn == t); //while other wants to enter &amp; it&#x27;s your turn
		/* CRITICAL SECTION */
		w[t] = false;  //no longer wants to enter
}</code></pre><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="af11cd7d-f5ae-4aa9-8f9a-e7656b0751ab"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%">The lock here is called a <strong>spin-lock</strong><ul id="a2667063-2b2e-4a01-bc6b-4e2268f10ffe" class="block-color-gray bulleted-list"><li style="list-style-type:disc">due to the while loop, which keeps ‚Äúspinning‚Äù until it‚Äôs the threads turn to enter</li></ul></div></figure><ul id="226bd69c-a1eb-4ea1-97e6-37ade1e25b8b" class="toggle"><li><details open=""><summary><mark class="highlight-teal"><strong>Mutual Exclusion</strong></mark></summary><p id="5b12421a-772e-4a9b-a820-327c7253dce1" class=""><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">T_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> &amp; <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> can‚Äôt both be in the critical section. <div class="indented"><p id="51e09313-408e-488f-ac1a-ecc479b76da2" class="">Both can be want to enter <mark class="highlight-gray">(</mark><mark class="highlight-gray"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo><mo>=</mo><mi>w</mi><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo>=</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">w[0]=w[1]=true</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span></span></span></span></span><span>Ôªø</span></span></mark><mark class="highlight-gray">)</mark></p><p id="68a98fdd-2730-4abe-99ef-0c619c8ae701" class="">But <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mrow><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">n_{turn}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> can be only 1 value <mark class="highlight-gray">(</mark><mark class="highlight-gray"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span>Ôªø</span></span></mark><mark class="highlight-gray"> or </mark><mark class="highlight-gray"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span>Ôªø</span></span></mark><mark class="highlight-gray">)</mark></p><p id="43b84df2-832c-4e1e-a116-5df11f4c9d12" class="">‚áí only one can be in the critical section <mark class="highlight-gray">(whoever last set n_turn) </mark></p></div></p></details></li></ul><ul id="7f6fe828-c394-4815-a1c6-cc3558deee59" class="toggle"><li><details open=""><summary><mark class="highlight-teal"><strong>Progress</strong></mark></summary><p id="f8517530-8332-4d42-97dc-b4330e65870b" class="">One thread does not want to enter CS ‚áí the other will <mark class="highlight-gray">(while loop breaks)</mark></p></details></li></ul><ul id="35510c9c-5a15-4853-a156-59d410c7f21e" class="toggle"><li><details open=""><summary><mark class="highlight-teal"><strong>Bounded Waiting</strong></mark></summary><p id="73b2f22c-6d1d-4c52-911f-736b197868fa" class="">Takes turns: <div class="indented"><p id="5d1e8756-26e9-4e91-84b3-db6128d25299" class=""><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">T_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> wants lock &amp; <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> tries to re-enter </p><p id="8d314f25-2da5-4601-8bcd-76ea1a6a9e49" class="">‚áí <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> sets <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mrow><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n_{turn} = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span>Ôªø</span></span> </p><p id="a1f138f7-dfd0-42ec-be3b-6491bf72efba" class="">‚áí  <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">T_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span>‚Äôs while loop stops spinning, allowing <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">T_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> to enter</p></div></p></details></li></ul><h3 id="084611ba-75a5-453f-9acc-8620ceadf129" class=""><mark class="highlight-red"><strong>Problems</strong></mark></h3><ol type="1" id="c8c8a420-235a-407e-bf64-1e42ae376afe" class="numbered-list" start="1"><li>Only works for 2 threads</li></ol><ol type="1" id="02cae9bb-242f-4cad-8969-10f9ea76ad52" class="numbered-list" start="2"><li>Requires <strong>sequential consistency</strong></li></ol><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="7e048dfd-c0b8-498f-a1e4-4544c484b461"><div style="font-size:1.5em"><span class="icon">‚ùì</span></div><div style="width:100%">The pieces of the code that create a lock need to execute in sequential order for the lock to do it‚Äôs job. The order is: <div id="6b1ff036-15cf-4eae-bcdb-056c53548783" class="column-list"><div id="470a829b-f57c-4de2-99e4-3863cba298ed" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="68efbd58-5607-463c-9805-b66b21c9a21d" class="code"><code class="language-C">w[t] = true;
n_turn = t;
while (w[1-t] &amp;&amp; n_turn == t);
/* CRITICAL SECTION */
w[t] = false;  </code></pre></div><div id="2f377631-b418-4baf-a27f-07ae36259d7c" style="width:50%" class="column"><ol type="1" id="ceb9b535-4b9a-43a8-9b52-0c69d57b4ad5" class="numbered-list" start="1"><li>Declare that you want to enter</li></ol><ol type="1" id="a5ec3bdf-ba7a-49a7-876c-1fa8289797d7" class="numbered-list" start="2"><li>Mark it as not your turn</li></ol><ol type="1" id="f94d6a0b-d005-4e05-8ed0-5d389a0aa43f" class="numbered-list" start="3"><li>Spin until you can enter</li></ol><ol type="1" id="c6d47d6a-74c0-4faa-b0e8-354cc3283caa" class="numbered-list" start="4"><li>Enter</li></ol><ol type="1" id="ac930ab4-45a5-4679-bd71-db37375f9ecd" class="numbered-list" start="5"><li>Declare that you don‚Äôt want to enter anymore</li></ol></div></div><p id="e3df5f23-c8de-4123-9d82-8a6147ee821a" class="">Without <em>sequential consistency</em>, this could happen: </p><div id="b7921521-f96f-4324-a6fa-603a00cee4ad" class="column-list"><div id="88c6f185-5d58-40e0-90bc-5de1c9663d77" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b5919392-ac29-4d54-9a00-cdea7d7bc3ef" class="code"><code class="language-C">w[t] = true;
while (w[1-t] &amp;&amp; n_turn == t);
n_turn = t;
/* CRITICAL SECTION */
w[t] = false;  </code></pre></div><div id="8d0d5ec4-a7f9-4179-a71a-95e3217af6b0" style="width:50%" class="column"><ol type="1" id="3302e7ab-497f-4244-aced-6f2708a6efc6" class="numbered-list" start="1"><li>Declare that you want to enter (same as before) </li></ol><ol type="1" id="00e5d6af-e37a-4a95-8fc4-94e470ad46b5" class="numbered-list" start="2"><li>Instead of marking it as your turn, start spinning ‚áí fails right away since it‚Äôs your turn</li></ol><ol type="1" id="a0c40daf-9478-4ab0-9e76-ba42aab164e0" class="numbered-list" start="3"><li>set it as your turn ‚áí now the other thread stops spinning. </li></ol><p id="5eab885a-6139-4639-8bdd-3cbf230daa52" class="">
</p></div></div><p id="9f0636e5-f623-423d-a644-e0b497831945" class="block-color-red"><mark class="highlight-default">Clearly, both threads can be in the critical section at once </mark></p></div></figure></div></details><hr id="a0dfb357-7557-4049-b624-299d061be183"/><h1 id="2bf2d0ca-a771-4ef2-bdfa-18a1dd1e3cfb" class=""><mark class="highlight-red">Mutual Exclusion without S.C</mark></h1><p id="23a40c1c-4de9-43a7-9eba-798a62bb9b8c" class="">Don‚Äôt <strong>assume </strong>the model has S.C. </p><p id="7603ad94-6f72-4a13-9820-b251f1c06883" class="">We can write race-free applications without requiring sequential consistency by enforcing ordering in specific places (critical sections). </p><h2 id="091a048e-10da-46ed-a196-123dbaaf1c1f" class="">Barriers</h2><p id="cbd59d0c-cbf3-4d1e-9ea0-cd4e7cd953f1" class=""><mark class="highlight-gray"><em>We use these to implement a spinlock (basis of all locks)</em></mark></p><p id="a8c33caf-30f7-42f5-8882-16e3822f2aa0" class="">At the low-level, manually adding <em>fences</em> and <em>locked instructions</em> in the code. </p><ol type="1" id="754f6602-b862-41db-8404-66717585b118" class="numbered-list" start="1"><li><mark class="highlight-default"><code>Xchg</code></mark> </li></ol><ol type="1" id="2cfef97a-e5c4-4a4b-b653-431fc46ef148" class="numbered-list" start="2"><li><mark class="highlight-default"><code>Fence</code></mark> </li></ol><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="34636fa7-58c2-460e-9990-7970cd7aec80"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/code_gray.svg"/></div><div style="width:100%"><strong>Xchg</strong><hr id="088de8af-5ef7-48cd-9b4c-2749608d1ab3"/><p id="ab7c6775-e8ab-44f3-942e-26c0065303f3" class="">Set a value atomically. Return old value</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4eeb6991-cc34-455f-b6c2-e1854e8e8301" class="code"><code class="language-C">Xchg(value, addr) {
	old = *addr;   //save old value at address
	*addr = value; //overwite value at that address w&#x27; new value
	return(old);   //return old value
}</code></pre><p id="c6482684-f60f-48a0-a501-a23bba5fb585" class=""><mark class="highlight-gray">We can use this both </mark><mark class="highlight-gray"><span style="border-bottom:0.05em solid"><em>test</em></span></mark><mark class="highlight-gray"><em> </em></mark><mark class="highlight-gray">and </mark><mark class="highlight-gray"><span style="border-bottom:0.05em solid"><em>set</em></span></mark><mark class="highlight-gray"><em> </em></mark><mark class="highlight-gray">a lock atomically</mark></p></div></figure><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="5e53e324-4644-4b42-9020-595a6d40bf54"><div style="font-size:1.5em"><img class="icon" src="https://www.notion.so/icons/code_gray.svg"/></div><div style="width:100%"><strong>Fences</strong><hr id="0425f1c4-7a77-4789-9861-2fd3e7a5ee57"/><p id="c32ffc52-75e0-4d76-839b-f03ea96f2e03" class=""><em>hardware instruction (not a function)</em></p><p id="e7bfa15f-6951-4005-a7ea-b9a400b03e5b" class=""><mark class="highlight-default"><code>mfence</code></mark></p><ul id="c960dccf-88c6-4ca3-9db4-ddf98f4c6030" class="bulleted-list"><li style="list-style-type:disc">prevents read/write operations before the fence to be reordered such that they execute after the fence.</li></ul><ul id="5a5b39c5-2dec-47d8-a766-de0581f7b928" class="bulleted-list"><li style="list-style-type:disc">prevents read/write operations after the fence to be reordered such that they execute before the fence.</li></ul><p id="51484ebf-8312-4597-ac62-44a91c1e2954" class=""><mark class="highlight-default"><code>lfence</code></mark></p><ul id="f3cc361c-407d-4804-b034-19d180ed216a" class="bulleted-list"><li style="list-style-type:disc">only loads</li></ul><p id="d9c525e8-0e42-457a-b0be-731592f33be7" class=""><mark class="highlight-default"><code>sfence</code></mark></p><ul id="5eff52c3-0c5a-4513-8473-d514b95e0fb8" class="bulleted-list"><li style="list-style-type:disc">only stores </li></ul><hr id="883ee26d-e50f-4931-924b-567f3d2fcb9d"/><p id="453c31a5-21b6-48ae-9d0e-415f5d518863" class="">This is important when you are trying to provide mutual exclusion for your critical section. You don&#x27;t want memory operations outside of the critical section to execute inside your critical section. You also don&#x27;t want memory operations inside your critical section to execute outside of your critical section.</p></div></figure><h2 id="44017ead-be5c-4d00-8478-0a020552848f" class="">High Level ‚Äî Locks</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="86ea8592-9fc6-4e8b-b9ac-c9b64213551a" class="code"><code class="language-C" style="white-space:pre-wrap;word-break:break-all">int total = 0; //held in r8
bool lock = false; </code></pre><div id="06756140-bd0e-4c87-a33c-933feaaf01bb" class="column-list"><div id="0dc40b97-0b8e-4868-bc32-d62272f7c5df" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="202bdb25-f440-42cd-9a87-112bc0a4ec1f" class="code"><code class="language-C">void add() {
	for (int i=0; i&lt;N; i++) {
		Acquire(&amp;lock);
		total++;
		Release(&amp;lock);
	}
}</code></pre></div><div id="8b78cec0-59b4-4070-a731-0e91f0220e6e" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3187c714-9c85-45f4-8189-70e447e94b94" class="code"><code class="language-C">void sub() {
	for (int i=0; i&lt;N; i++) {
		Acquire(&amp;lock);
		total--;
		Release(&amp;lock);
	}
}</code></pre></div></div><p id="b227e749-ca1b-456a-9f3c-31b56dbf091b" class="">Different ways to implement <code>Acquire</code> &amp; <code>lock</code> ?</p><div><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><mark class="highlight-orange"><strong>#1 - Spin Lock </strong></mark></summary><div class="indented"><p id="10d250df-0b07-4f37-a2a0-0b8e2cd2fcf6" class=""><mark class="highlight-gray"><em>This solution improves Peterson‚Äôs problem of only working for fixed # threads. </em></mark></p><div id="dd05a1cd-2ad8-4a73-93bd-ddd15f3a0e2f" class="column-list"><div id="2cd7a69b-b15c-44ad-87cb-9e528c647461" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ba7b1991-42b4-4fe2-8484-04eb750e65d6" class="code"><code class="language-C">Acquire(bool* lock) {
	while (Xchg(true, lock) == true);
}</code></pre></div><div id="5a7b301c-0f28-45da-9659-11f56596bab0" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="674ef431-69e5-4d87-a89e-e0be47d46e4c" class="code"><code class="language-C">Release(bool* lock) {
	Xchg(false, &amp;lock);
}</code></pre></div></div><ul id="4e0e34ca-85c7-455c-9b2e-c005527bed5e" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-default"><code>Xchg</code></mark> returns <em>false</em> as soon as a thread gives up the lock</li></ul><ul id="3ff9f3e1-f8cc-43de-87c2-306385de5123" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-default"><code>Xchg</code></mark> returns <em>true</em> while another thread has the lock.  </li></ul><ul id="b4ad656e-bd85-440b-99d8-f3aa5b74fe68" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-default">A thread </mark><mark class="highlight-red"><em>spins</em></mark><mark class="highlight-default"><em> </em></mark><mark class="highlight-default">in </mark><mark class="highlight-default"><code>Acquire</code></mark><mark class="highlight-default"> until the lock is free</mark></li></ul><h3 id="10b235da-23b0-4c6c-aa01-578e0baf9158" class=""><mark class="highlight-red"><strong>Problem</strong></mark></h3><ol type="1" id="48f16773-c74d-4ffd-81e5-bf7676720923" class="numbered-list" start="1"><li><em>Spinning</em> is wastefully checking the same value over &amp; over</li></ol><ol type="1" id="e125d0b2-ab5b-4ca9-aa2d-644c813d2c20" class="numbered-list" start="2"><li>Can‚Äôt guarantee <em>bounded-waiting</em><ul id="3fb8ae92-9077-49c9-a4ac-a0d0d98e87f9" class="bulleted-list"><li style="list-style-type:disc">Assume the user releases the lock. We don‚Äôt know the relative order of <code><mark class="highlight-default">xchg</mark></code><mark class="highlight-default"> </mark>between threads. It‚Äôs very unlikely, but possible that one thread will always get it first.</li></ul></li></ol></div></details></div><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0"><mark class="highlight-red"><strong>Wait Channel</strong></mark></summary><div class="indented"><p id="f32e1649-03a9-4f53-a289-085d0b942069" class=""><mark class="highlight-gray"><em>kernel level data structure</em></mark></p><table id="aad68f80-76d3-44d0-a953-d47724828abb" class="simple-table"><tbody><tr id="6135e952-2f2a-4004-945d-aa99df0d1b6e"><th id="]|Nn" class="simple-table-header-color simple-table-header" style="width:96.98579406738281px">lock</th><td id="f;sf" class=""><em>spinlock</em> for access to <em>chanQueue</em></td></tr><tr id="8882e470-fec7-480a-aa17-ede212948572"><th id="]|Nn" class="simple-table-header-color simple-table-header" style="width:96.98579406738281px">queue</th><td id="f;sf" class="">holds sleeping threads</td></tr></tbody></table><table id="db1fc19c-7139-4f28-9d4a-7dceaca8b02a" class="simple-table"><thead class="simple-table-header"><tr id="241224e7-8fa4-4701-b3f3-42c573166388"><th id="Nhvt" class="simple-table-header-color simple-table-header" style="width:108.98863220214844px">Function</th><th id="RdQ&lt;" class="simple-table-header-color simple-table-header" style="width:164.99999237060547px">What</th><th id="DKgq" class="simple-table-header-color simple-table-header" style="width:296.9715881347656px">How</th></tr></thead><tbody><tr id="e3c3f85b-8f8b-467c-8291-9c2438f67889"><td id="Nhvt" class="" style="width:108.98863220214844px"><code>Lock</code></td><td id="RdQ&lt;" class="" style="width:164.99999237060547px">Acquires<em> </em>the <em>spinlock</em></td><td id="DKgq" class="" style="width:296.9715881347656px"></td></tr><tr id="303970af-3e18-4183-82fb-8cedbc653b57"><td id="Nhvt" class="" style="width:108.98863220214844px"><code>Sleep</code></td><td id="RdQ&lt;" class="" style="width:164.99999237060547px">Places the current thread to asleep while releasing the wait channel lock.</td><td id="DKgq" class="" style="width:296.9715881347656px">1. Transitions current thread, <em>run </em>‚Üí <em>wait<br/><br/></em>2. Add‚Äôs it to queue<br/>3. Release the <br/><em>spinlock<br/><br/></em>4. Tell the scheduler to run a new one. </td></tr><tr id="589f4c49-a6d5-4b80-8630-3192e0ff19dd"><td id="Nhvt" class="" style="width:108.98863220214844px"><code>Wake</code></td><td id="RdQ&lt;" class="" style="width:164.99999237060547px">Unblocks a thread sleeping on the <em>wait-channel</em></td><td id="DKgq" class="" style="width:296.9715881347656px">1. Acquire <em>lock</em><br/>2. Schedule thread from <br/><em>chanQueue</em><br/>3. Release <br/><em>lock</em></td></tr><tr id="05ac2cfa-bd3b-44be-9247-340fd07590c1"><td id="Nhvt" class="" style="width:108.98863220214844px"><code>WakeAll</code></td><td id="RdQ&lt;" class="" style="width:164.99999237060547px">Unblocks all </td><td id="DKgq" class="" style="width:296.9715881347656px"></td></tr></tbody></table><p id="4be4cacd-d98f-44f0-b25e-55857b1ac3d7" class=""><strong>Note: </strong>no <code>unlock</code> function. The caller needs to call <code>Sleep</code> sometime after <code>Lock</code> which will unlock the <em>spinlock </em>after putting the thread to sleep. </p></div></details><div><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><mark class="highlight-orange"><strong>#2 ‚Äî Mutex</strong></mark></summary><div class="indented"><ul id="563de62d-b4b9-486d-9e9b-f9b8692ee113" class="bulleted-list"><li style="list-style-type:disc">Blocks the thread until the lock can be acquired (another thread releases it)</li></ul><ul id="3a630954-4f90-41b1-9290-5cf13d5dc165" class="bulleted-list"><li style="list-style-type:disc">Mutex‚Äôs are shared, so we need mutual exclusion ‚Üí <strong>spinlocks</strong></li></ul><ul id="08869f49-1d26-4f4a-b61a-3c45fe46779d" class="bulleted-list"><li style="list-style-type:disc">blocking is implemented with <strong>wait-channels</strong></li></ul><p id="91921592-916f-4e95-aed4-8264b4ac8fae" class=""><strong>Data Structure</strong></p><table id="4716db7a-a615-4ebb-9fa0-54631a787bc6" class="simple-table"><tbody><tr id="4231b597-87d3-4e54-8151-8cb02b07a6c8"><th id="U}AI" class="simple-table-header-color simple-table-header" style="width:88.9921875px">status</th><td id="?aQk" class="">taken or not</td></tr><tr id="0de76256-196e-43ec-927d-cce1b38aa215"><th id="U}AI" class="simple-table-header-color simple-table-header" style="width:88.9921875px">owner</th><td id="?aQk" class="">Thread * </td></tr><tr id="08bf15ec-7c24-4c86-8a98-9497dabd325b"><th id="U}AI" class="simple-table-header-color simple-table-header" style="width:88.9921875px">lock</th><td id="?aQk" class="">SpinLock * </td></tr><tr id="c4848a2e-15f9-40a8-a09d-0f7baac1b4f8"><th id="U}AI" class="simple-table-header-color simple-table-header" style="width:88.9921875px">chan</th><td id="?aQk" class="">WaitChannel * </td></tr></tbody></table><h3 id="f47b4980-6cdb-47b7-b90b-f98b66b4b400" class="">Functions</h3><h3 id="af99d4a6-ab9a-4e68-b092-c0cf009fe245" class=""><code>lock</code></h3><p id="4d4a10e4-889f-43e7-b15b-37aaf7cbabff" class="">Acquire Mutex (blocking)</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b7ce5518-fa01-459d-8bb5-ad030eb70b3f" class="code"><code class="language-C">Spinlock_Lock(m.lock)
--------- m c.s ---------
	while (m.status == taken) {
		WaitChannel_Lock(m.chan)
		Spinlock_Unlock(m.lock)    // ***
		WaitChannel_Sleep(&amp;m.chan) // unlocks chan
		‚Üê mutex is unlocked (someone may or may not acquire before next line)
		Spinlock_Lock(m.lock)
	}
	‚Üê mutex is free to grab
	Set the thread as m&#x27;s owner
	set status to taken
--------- m c.s ---------
Spinlock_Unlock(m.lock)</code></pre><h3 id="80c2e7a8-b229-441d-b5c4-13cfd4f6ace0" class=""><code>trylock</code></h3><p id="e9650320-c96d-4f32-beff-ab60dda6f273" class="">Attempt to acquire the mutex, return 0 or -1 (non-blocking)</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a305062a-96e8-41ec-a440-35cd03d463b5" class="code"><code class="language-C">Spinlock_Lock(m.lock)

	bool return_val;

	if ( m is owned )
		return_val =  false;
	else:
		owner = cur_thread()
		return_val = true

Spinlock_Unlock(m.lock)

return return_val</code></pre><h3 id="4f0f3cd5-749c-4a78-b314-b90c2eec9c14" class=""><code>unlock</code></h3><p id="1ffc67d8-87e5-4665-a189-33b7a195397d" class="">Release Mutex (non-blocking)</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ce85164c-02bd-452e-92bd-47e78308f67c" class="code"><code class="language-C">Spinlock_Lock(m.lock)
--------- m c.s ---------
		remove current owner
		set status to not taken
    WaitChannel_Wake(m.chan) //wake up some thread on the wait channel
--------- m c.s ---------
Spinlock_Unlock(m.lock)</code></pre><p id="fd225a5a-7e56-4c16-97e7-8a2cdffed182" class="">
</p></div></details></div><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="069b8635-8352-47db-8e05-dcbd7f99d014"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%"><strong>Hand-Over-Hand Locking</strong><p id="05599794-a4dc-4dd7-8927-cf5be688be08" class="">Taking the wait channel spinlock before unlocking the mutex spinlock is called ‚Äú<strong>hand-over-hand</strong>‚Äù It‚Äôs prevents ‚Äúlost wakeup‚Äù </p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fc38f7a2-e5e6-4382-9d0b-05120bc03d1f" class="code"><code class="language-C">WaitChannel_Lock(m.chan)
Spinlock_Unlock(m.lock)    </code></pre><p id="645a7cf2-d2fa-4f8d-931f-6acf03415efe" class=""><strong>lost wakeup: </strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="74ddc516-d239-416c-88de-4a3d34f8a8f5" class="code"><code class="language-C">Spinlock_Unlock(m.lock)
// &lt;- Mutex_Unlock called from another thread
WaitChannel_Lock(m.chan) </code></pre><ul id="ccfea16a-dbae-4199-a524-3e0d3c95ec32" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> may call run Mutex_Unlock before the locking <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> blocks on the wait channel</li></ul><ul id="317f83f8-9382-4023-867d-4a48211fa3fc" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> sleeps even though the mutex is now unlocked. </li></ul><ul id="8d426043-a410-41c5-beb5-ddb93bf34dc9" class="bulleted-list"><li style="list-style-type:disc">It can only be woken up when another thread calls Mutex_Unlock; could be blocked indefinitely.</li></ul></div></figure><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="33861753-ebdd-46c1-8acc-6535109b6952"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%"><strong>Can‚Äôt use a Mutex inside the kernel </strong><p id="b61b0507-5f1d-4d23-bf8a-4b2a7918b0ab" class=""><em>Mutex</em> requires 1 thread to unlock it so that another can be unblocked. </p><p id="d8d80e2c-bba7-4ad5-a6b3-da43d8760941" class="">But, there‚Äôs only 1 kernel thread. It can‚Äôt wake itself up.</p><ul id="7144859a-ced3-4481-903a-e3e88a5f31e2" class="bulleted-list"><li style="list-style-type:disc">Ex: If you have a lock, and you acquire a mutex, if an interrupt fires, you jump to the interrupt handler. If the handler tries to acquire the same mutex, it will put the thread to sleep. Forever. <strong>DEADLOCK </strong>on itself. </li></ul></div></figure><h1 id="26231775-2607-428f-9951-9e3083e67bf2" class=""><mark class="highlight-purple">Producer / Consumer Problem</mark></h1><p id="7a3bd16e-48dd-4e35-ae6e-04efc7d31a97" class=""><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> produces data, <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> consumes the data. Can‚Äôt consume if there‚Äôs no data. Can‚Äôt produce if there‚Äôs too much data</p><h3 id="45808b3a-12e7-4704-af7f-5ca02c5a96c6" class="">Example</h3><p id="7818c38d-211a-4c71-8d24-ccdceb872bb4" class="">Assume there‚Äôs a circular queue, <code>buffer</code> &amp; a <code>count</code> global. </p><ul id="d88650d7-9b3f-4fda-b671-afb199a605dd" class="bulleted-list"><li style="list-style-type:disc">Producer spins while buffer is full. </li></ul><ul id="28c68367-0abb-4bde-b652-0198917698fe" class="bulleted-list"><li style="list-style-type:disc">Consumer spins while buffer is empty. </li></ul><div id="35e229f8-b294-4724-a4c1-99a5fa57a172" class="column-list"><div id="c7dc1c17-ec65-4a05-bdf0-e03b9d74599e" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="529d6759-06b8-48e2-9c88-929de8997dbb" class="code"><code class="language-C">void producer (void *ignored) {
	for (;;) {
		item *nextProduced = produce_item ();
		while (count == BUFFER_SIZE);
		buffer[in] = nextProduced;
		in = (in + 1) % BUFFER_SIZE;
		count++;
	}
}</code></pre></div><div id="5b663f27-abcf-4de4-b7db-e139b94e2201" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f1e7faeb-c6f9-4f0a-abae-7b179e209cce" class="code"><code class="language-C">void consumer (void *ignored) {
	for (;;) {
		while (count == 0);
		item *nextConsumed = buffer[out];
		out = (out + 1) % BUFFER_SIZE;
		count--;
		consume_item (nextConsumed);
	}
}</code></pre></div></div><p id="5fab29e7-73b0-4db5-8fff-3033905c2ffb" class=""><mark class="highlight-red"><strong>Problem</strong></mark></p><p id="729f4f9a-7daf-49dc-bdfc-c49e2af610ff" class="">No mutual exclusion on <code>count</code> </p><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0">Solution 1 </summary><div class="indented"><p id="3756037b-5c17-47d2-8bad-77f24eb9f4b0" class="">Use mutex for the critical section </p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9b144d70-f8d8-49d9-9e07-19e53dcfec0a" class="code"><code class="language-C">mutex_t mutex = MUTEX_INITIALIZER; //lock on count</code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c0fa0a5b-55e5-4589-b6af-eec16eda5e09" class="code"><code class="language-C">void producer (void *ignored) {
	for (;;) {
		item *nextProduced = produce_item ();

		mutex_lock(&amp;mutex);
	/*----CRITICAL SECTION----*/
		while (count == BUFFER_SIZE) {
			// Buffer is full. Can&#x27;t make forward progress
			mutex_unlock(&amp;mutex);  // let consumer go
			thread_yield();        // let someone else run (optional)
			mutex_lock(&amp;mutex);    // since we are going back into the while loop
		}

		buffer [in] = nextProduced;
		in = (in + 1) % BUFFER_SIZE;
		count++;
	/*----CRITICAL SECTION----*/
		mutex_unlock(&amp;mutex);
	}
}</code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2eddc52a-890c-430b-8266-0ff84ad052fb" class="code"><code class="language-C">void consumer (void *ignored) {
	for (;;) {
		mutex_lock(&amp;mutex);
	/*----CRITICAL SECTION----*/
		while (count == 0) {
			mutex_unlock(&amp;mutex);
			thread_yield();
			mutex_lock(&amp;mutex);
		}
		item *nextConsumed = buffer[out];
		out = (out + 1) % BUFFER_SIZE;
		count--;
	/*----CRITICAL SECTION----*/
		mutex_unlock(&amp;mutex);

		consume_item (nextConsumed);
	}
}</code></pre><p id="ca7464b5-2560-45b2-90b3-25225710f562" class=""><mark class="highlight-red"><strong>Problem</strong></mark></p><p id="bf0186c5-c861-4920-bc55-b865ee4cca10" class="">Expensive to <em>spin</em> while performing locks/unlocks</p></div></details><div><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><mark class="highlight-orange">#3 ‚Äî CV</mark></summary><div class="indented"><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="8d2db62c-1b01-40b8-9d5c-7e266de91308"><div style="font-size:1.5em"><span class="icon">‚ùó</span></div><div style="width:100%"><mark class="highlight-red"><strong>Condition Variable</strong></mark><hr id="2cf843c1-23cb-4aa5-a883-f7bbfe57a114"/><ul id="337c1132-0623-4041-b12f-5be20e5b8dd4" class="bulleted-list"><li style="list-style-type:disc">Threads must sometimes wait for some system-wide event to happen, and cannot proceed otherwise. They wait on a CV, putting themselves to sleep indefinitely. Then, when the event happens, the running thread that triggered the event notifies the sleeping thread by signalling to the CV.</li></ul><ul id="de8e33ed-ace9-4981-be95-ed878991097f" class="bulleted-list"><li style="list-style-type:disc">CVs:<ul id="2b494797-df5f-43b0-86ec-dde8dba5382a" class="bulleted-list"><li style="list-style-type:circle">simple wrapper over <code>wait-channels</code></li></ul><ul id="7d8ebc04-2df0-49e6-ab39-edde9c2bc63f" class="bulleted-list"><li style="list-style-type:circle">provide a more intuitive alternative, without spinlock‚Äôs and wait-channels.</li></ul><ul id="5b65d423-79a8-4bed-af75-bab91b91183d" class="bulleted-list"><li style="list-style-type:circle">makes it easy to avoid <strong><em>deadlock</em></strong> and <strong><em>lost-wakeup</em></strong>.</li></ul></li></ul><hr id="85ac4071-e41e-4a27-82d6-2ee136d5222a"/><div id="87925cdd-f209-4eff-b7eb-3023b419fca2" class="column-list"><div id="62bcad6f-8b36-464b-842e-383541b3703d" style="width:50%" class="column"><p id="d2f716d2-3a82-4121-905a-3c126fa73991" class=""><strong>Waiter</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="85098126-b0f1-4ea8-959b-ab0b2a1ba5c2" class="code"><code class="language-C">Mutex_Lock(mtx)
while not condition {
	CV_Wait(cv, mtx)
}
Mutex_Unlock(mtx)</code></pre></div><div id="8b3086e3-5429-466f-8ccb-d7bbc12bca37" style="width:50%" class="column"><p id="3f84b3e4-4b5d-409b-af23-908ce46a4e5b" class=""><strong>Signaler</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e3120669-f27d-488a-a938-446b6bef52dd" class="code"><code class="language-C">Mutex_Lock(mtx)
	// do work
	set condition to true
	CV_Signal(cv, mtx)
Mutex_Unlock(mtx)</code></pre></div></div><hr id="ff414732-2a38-4b35-b4d5-330ad42ba183"/><ul id="ff1c91ad-5373-4b2c-ab9c-1a529daa5176" class="toggle"><li><details open=""><summary><strong>API</strong></summary><table id="5f2d3b1e-a476-4ce8-afdd-5c0abf01f234" class="simple-table"><tbody><tr id="eb696fbb-1ba4-47c8-8e8f-752cd795c19e"><th id="Z~IX" class="simple-table-header-color simple-table-header" style="width:58.99999237060547px">chan</th><td id="^kAT" class="">WaitChannel</td></tr></tbody></table><ul id="3dca5287-5003-4fd5-8f9d-f8b1cd990f31" class="bulleted-list"><li style="list-style-type:disc">does not actually store the condition</li></ul><ul id="247c88b4-ebf4-4a2b-9f1c-a37f1903e384" class="bulleted-list"><li style="list-style-type:disc">simple wrapper over <code>wait-channels</code></li></ul><table id="15b0f765-35d3-4f38-9f8c-08a830eb6b4c" class="simple-table"><tbody><tr id="0917f07d-68b1-4498-ab4b-0199230e3e9a"><td id="AUPP" class=""><code>init(c)</code></td><td id="mAKP" class="" style="width:424.99998474121094px"></td></tr><tr id="1f353a2f-4cf7-4a08-b5cc-00b386b6d1f2"><td id="AUPP" class=""><code>wait(c, m)</code></td><td id="mAKP" class="" style="width:424.99998474121094px">Block the thread until <em>signaled</em></td></tr><tr id="d9ae3749-344a-4641-98ba-40717df31fda"><td id="AUPP" class=""><code>signal(c)</code></td><td id="mAKP" class="" style="width:424.99998474121094px">calls <code>WaitChannel_Wake</code></td></tr><tr id="50cb7e0e-9edc-404c-b801-c2894d6569db"><td id="AUPP" class=""><code>broadcast(c)</code></td><td id="mAKP" class="" style="width:424.99998474121094px">calls <code>WaitChannel_WakeAll</code></td></tr></tbody></table><p id="dd20c58a-1658-4641-82b3-7c1fb56e88d7" class=""><code>CV_Wait</code></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="40a67432-c3c8-4acb-b095-68b1248a75c7" class="code"><code class="language-C">WaitChannel_Lock(chan)
Mutex_Unlock(mtx)
WaitChannel_Sleep()
&lt;- mutex is unlocked =&gt; signaler set condition to true
Mutex_Lock(mtx)</code></pre><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="37536ea2-4149-44e3-8d50-3d2cf54c7ce7"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%"><strong>Why </strong><mark class="highlight-default"><code><strong>wait</strong></code></mark><strong> needs to (1) release mutex &amp; (2) sleep, atomically </strong><p id="eb3f980c-07d8-4f76-8673-323f572a613d" class="">What if we separated the mutex and condition variable? </p><figure id="d201b41c-837d-43c0-97c1-94d67efa8192" class="image"><a href="M4%20-%20Concurrency/Screen_Shot_2024-02-28_at_16.49.42.png"><img style="width:288px" src="M4%20-%20Concurrency/Screen_Shot_2024-02-28_at_16.49.42.png"/></a></figure><ol type="1" id="4fcf5585-3b9a-4a59-8914-117988689c00" class="numbered-list" start="1"><li><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> unlocks mutex</li></ol><ol type="1" id="71b0cc3c-6a51-4174-a5f0-2e898bb59ef0" class="numbered-list" start="2"><li>Context switch ‚Üí <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span></li></ol><ol type="1" id="6be6f8e7-bdbc-41d0-a06e-58e57846a880" class="numbered-list" start="3"><li><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> changes count changes ‚Üí <em>not full</em> </li></ol><ol type="1" id="9bdc3b08-3aa0-4ac0-93ff-9569149db72b" class="numbered-list" start="4"><li>Other threads get signaled, but not <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> since it‚Äôs no longer in the queue</li></ol><p id="944d72a5-aafc-4c7f-9b10-7114a77e3847" class=""><strong><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span></strong><strong> is waiting for the condition forever</strong></p></div></figure></details></li></ul></div></figure></div></details></div><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0">Solution 2</summary><div class="indented"><p id="3d5205b5-bcba-41e7-91c3-73b4b31a1b1c" class="">Instead of <em>spinning </em>on some condition, block the thread until the <em>condition </em>is true</p><p id="0453e613-80f6-4ccd-9b8b-b8c770a38515" class="">Typically done with <em>condition variables</em>. </p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4c57fc98-3595-4674-9cf7-56a79580fa8e" class="code"><code class="language-C">mutex_t mutex = MUTEX_INITIALIZER; //lock on count
cond_t nonempty = COND_INITIALIZER;
condt_t nonfull = COND_INITIALIZER; </code></pre><div id="051e2549-3444-40ce-948a-d42d33030d00" class="column-list"><div id="0ea1468b-8c5f-485a-a474-9b496fc0b9dc" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b99fbf6e-f6fb-4345-9c12-2d0ee1298dbf" class="code"><code class="language-C">void producer (void *ignored) {
	for (;;) {
		item *nextProduced = produce_item ();
		mutex_lock(&amp;mutex);

				while (count == BUFFER_SIZE) {
					cond_wait(&amp;nonfull, &amp;mutex);
				}
				buffer [in] = nextProduced;
				in = (in + 1) % BUFFER_SIZE;
				count++;
				cond_signal(&amp;nonempty); //wake up producer thread

		mutex_unlock(&amp;mutex);
	}
}</code></pre><p id="5f4ef002-0254-48ef-8811-ec04317e8566" class="">
</p></div><div id="07e6fa65-aee0-4b4a-8728-b96c9d6e7944" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0f148b14-5253-4fec-b91d-80f4e9c26593" class="code"><code class="language-C">void consumer (void *ignored) {
	for (;;) {
		mutex_lock(&amp;mutex);

				while (count == 0) {
					cond_wait(&amp;nonempty, &amp;mutex);
				}
				item *nextConsumed = buffer[out];
				out = (out + 1) % BUFFER_SIZE;
				count--;
				cond_signal(&amp;nonfull); //wake up consumer thread

		mutex_unlock(&amp;mutex);
		consume_item(nextConsumed);
	}
}</code></pre><p id="2e705814-8e34-4e02-936d-cddcc9e1cef7" class="">
</p></div></div><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="ea7cebe4-3e70-4eda-ab69-0ee4e5e0d18a"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%"><strong>Why we still need while-loops</strong><p id="e7d16eec-87e6-41a0-a947-d376b3737925" class="">Always re-check condition on wakeup.</p><p id="921655e1-59f8-44f9-b25a-457dd63039c2" class="">We can‚Äôt guarantee your woken up because of a specific condition</p><ol type="1" id="01b54e4e-8f2b-475c-b52c-39227052de39" class="numbered-list" start="1"><li>Could have <mark class="highlight-red"><strong>spurious wakeup </strong></mark><em>(OS woke you up, not a thread)</em></li></ol><ol type="1" id="2f635960-0115-4048-9f3b-8b0fde3bd30d" class="numbered-list" start="2"><li>Multiple Consumers<ul id="16809015-26b3-454b-bb86-eed89af5c6da" class="toggle"><li><details open=""><summary><strong>Ex: </strong></summary><figure id="3fc2d88e-4781-4033-be5b-148756963078" class="image"><a href="M4%20-%20Concurrency/Screen_Shot_2024-02-28_at_16.42.54.png"><img style="width:1618px" src="M4%20-%20Concurrency/Screen_Shot_2024-02-28_at_16.42.54.png"/></a></figure><ul id="dbec8a7c-b51b-4389-bf3c-66e1e4425ee2" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> waits for <code><em>nonempty</em></code><em> </em>buffer</li></ul><ul id="791ade55-c87f-4724-bed1-31033fb1844e" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span><span>Ôªø</span></span> fills the buffer ‚Üí wakes up <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span>, unlocks mutex, count <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span>Ôªø</span></span></li></ul><ul id="19a293b6-e2af-43d1-bef3-6afc2c00abbc" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> acquires the lock</li></ul><ul id="277ac418-e81e-439c-b994-6f4bb58cae89" class="bulleted-list"><li style="list-style-type:disc"><link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span> consumes the item ‚Üí count <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span>Ôªø</span></span>, unlocks</li></ul><ul id="be125970-0190-423e-9564-ec8f5a809069" class="bulleted-list"><li style="list-style-type:disc">If we don‚Äôt recheck the condition in <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>Ôªø</span></span>, it consumes from the empty buffer. </li></ul></details></li></ul></li></ol></div></figure></div></details><div><details open=""><summary style="font-weight:600;font-size:1.5em;line-height:1.3;margin:0"><mark class="highlight-orange">#4 ‚Äî Semaphore</mark></summary><div class="indented"><figure class="block-color-default callout" style="white-space:pre-wrap;display:flex" id="b9c3dd08-4f81-4a02-a347-d6763f5c1d6d"><div style="font-size:1.5em"><span class="icon">‚ùó</span></div><div style="width:100%"><mark class="highlight-red"><strong>Semaphore</strong></mark><hr id="1b148b55-62fe-4ea9-996e-048129450142"/><p id="27781e6d-81b2-479e-aba1-af4199896cf3" class=""><em>synchronization primitive </em>that also holds a <em>count</em></p><hr id="2ab78542-6789-4eec-a0dd-226d9ed19b49"/><p id="e4871dd2-fe56-4f5e-873e-e7d89c0568ef" class=""><strong>Data Structure</strong></p><table id="9570e2b2-5bb5-4bf7-a889-ea3dc22a8396" class="simple-table"><tbody><tr id="4d0511e4-52b8-4679-be01-b849835073cb"><td id="RKLa" class="">WaitChannel *</td><td id="`\|M" class="" style="width:88px">wchan</td></tr><tr id="eb2a98f9-b680-4519-8168-c0918e7a2e28"><td id="RKLa" class="">int</td><td id="`\|M" class="" style="width:88px"><em>count</em></td></tr></tbody></table><p id="68344b71-2e91-4329-adc1-fe7b9f117c13" class=""><strong>Interface </strong></p><table id="9b8667ae-a07d-4909-bc1e-c9a419216620" class="simple-table"><tbody><tr id="c654376e-9787-46a7-99d3-240f539a1079"><th id="AUPP" class="simple-table-header-color simple-table-header" style="width:93px"><code>sem_init</code></th><td id="mAKP" class="" style="width:227.9921875px">initialized with an integer <link rel="stylesheet" type="text/css" href="/course-notes/notion_styles.css"/><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span><span>Ôªø</span></span></td></tr><tr id="ba854127-f30a-4833-832f-84036154d6fc"><th id="AUPP" class="simple-table-header-color simple-table-header" style="width:93px"><code>sem_wait</code></th><td id="mAKP" class="" style="width:227.9921875px">decrement counter<br/>- blocks until not 0<br/></td></tr><tr id="d9563e22-33e2-4be2-9dfa-3962f242215d"><th id="AUPP" class="simple-table-header-color simple-table-header" style="width:93px"><code>sem_post</code></th><td id="mAKP" class="" style="width:227.9921875px">increment counter<br/>- unblock if = 0<br/></td></tr></tbody></table><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="08e061ff-7f6c-4dae-8b75-4fb5ff1f3f01" class="code"><code class="language-C">Semaphore_Wait(Semaphore *sem) {
	Spinlock_Lock(&amp;sem-&gt;sem_lock);
	/*----critical section----*/
		while (sem-&gt;sem_count == 0) {
			WaitChannel_Lock(sem-&gt;sem_wchan);  //aquire wchan lock
			Spinlock_Unlock(&amp;sem-&gt;sem_lock);  //release spin lock ()
			WaitChannel_Sleep(sem-&gt;sem_wchan);  // waits thread (end of queue), release spin lock, context switch
			Spinlock_Lock(&amp;sem-&gt;sem_lock);
		}
		sem-&gt;sem_count--;
	/*----critical section----*/
	Spinlock_Unlock(&amp;sem-&gt;sem_lock);
} </code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a5566048-d7fa-45e6-a1ef-4b3d49485cda" class="code"><code class="language-C">Semaphore_Post(Semaphore *sem) {
	Spinlock_Lock(&amp;sem-&gt;sem_lock);
	/*----critical section----*/
		sem-&gt;sem_count++;
	/*----critical section----*/
	WaitChannel_Wake(sem-&gt;sem_wchan); //acquire spin lock for wait channel
	Spinlock_Unlock(&amp;sem-&gt;sem_lock);
}</code></pre></div></figure></div></details></div><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="c4a72267-443e-4092-8b0f-91f592557e0b"><div style="font-size:1.5em"><span class="icon">üí°</span></div><div style="width:100%">Semaphore is very similar to a <em>mutex</em>. Except, instead of a taken/untaken, it‚Äôs a count. </div></figure><details open=""><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0">Solution 3</summary><div class="indented"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="31b1b290-0e32-42ef-ad5a-42d67759a217" class="code"><code class="language-C">Mutex * mtx; Mutex_Create( mtx )
sem_t full = sem_init(0);   // 0 full entries in BUFFER
sem_t empty = sem_init(N);  // N empty entries in BUFFER</code></pre><div id="eee74b32-372f-40f7-954d-80187d47aa35" class="column-list"><div id="73ae96e9-c0e1-443b-bede-931b9415c144" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a932ce8a-2006-4a00-9d9c-ed813d343485" class="code"><code class="language-C">void producer (void *ignored) {
	for (;;) {
		item *nextProduced = produce_item ();
		sem_wait(&amp;empty); // increment if # empty is not 0
		/*----CRITICAL SECTION----*/
				buffer [in] = nextProduced;
				in = (in + 1) % BUFFER_SIZE;
		/*----CRITICAL SECTION----*/
		sem_post(&amp;full);
	}
}</code></pre><p id="fec02887-bedd-409f-9f53-566c83a8ff01" class=""><code>full</code> is not incremented until after we produce. </p></div><div id="87c4b9e2-a021-4c6f-9859-90127127703b" style="width:50%" class="column"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="84fc6dc4-d22e-4a41-98f9-b9e1c2543e92" class="code"><code class="language-C">void consumer (void *ignored) {
	for (;;) {
		sem_wait(&amp;full);
	/*----CRITICAL SECTION----*/
		item *nextConsumed = buffer[out];
		out = (out + 1) % BUFFER_SIZE;
	/*----CRITICAL SECTION----*/
		sem_post(&amp;empty);
		consume_item (nextConsumed);
	}
}</code></pre><p id="5f93ab90-df51-4f6c-b8b5-b04efef9d4f8" class=""><code>empty</code> is not incremented until after we consume. </p></div></div><p id="62745fd4-4523-4141-9a07-900f09b82660" class=""><strong>Problem: </strong>This implementation does not allow for <em>multiple producers </em>or <em>multiple consumers. </em>Because we‚Äôre not providing mutual exclusion on <em>empty </em>&amp; <em>full. So </em>2 threads decrement count at the same time. </p><p id="ce914766-f9af-4371-9fcf-5e423eb7c808" class=""><strong>Solution: </strong><em>Mutex</em> for each of <em>full </em>&amp; <em>empty </em><mark class="highlight-gray"><em>(careful of deadlock)</em></mark></p></div></details><hr id="97a2ca82-b705-44b6-b693-ff0ef68d0af3"/><h3 id="e2c7d7f0-c784-47a0-a223-1930ec68564f" class=""><strong>Hand over Hand Locking</strong></h3><p id="3ec9476f-ccfc-40e3-9ee0-ce3ceecadac2" class="">Acquire 1 lock before you release the other (always have a lock in hand). </p><ul id="bec2ab14-6948-4310-86fe-1e433424ef62" class="toggle"><li><details open=""><summary><strong>Example: </strong></summary><figure id="363b9212-627c-46f8-ab19-aa4dee7eb5d5" class="image"><a href="M4%20-%20Concurrency/Screen_Shot_2024-02-28_at_17.46.43.png"><img style="width:192px" src="M4%20-%20Concurrency/Screen_Shot_2024-02-28_at_17.46.43.png"/></a></figure></details></li></ul><p id="c5222c4c-72c5-4b22-8da9-67b2ef1ffb96" class="">Useful for concurrent data structure manipulation. </p><ul id="c5b49b95-fae2-4903-80e7-15c9d6fc8156" class="bulleted-list"><li style="list-style-type:disc">hold at most 2 locks: previous and next</li></ul><ul id="52bd75f0-1ead-4c6f-b60b-6ea1156d21f5" class="bulleted-list"><li style="list-style-type:disc">locks must be ordered in a sequence </li></ul><ul id="74bde86b-e35b-462e-a93c-4000a06ced54" class="bulleted-list"><li style="list-style-type:disc">you may not go backwards</li></ul><p id="474cf16d-a73c-4495-a72c-1a7975f2d4cb" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"><hr/><details open="" style="padding-top:1em"><summary style="font-weight:600;font-size:1.25em;line-height:1.3;margin:0">Inline comments</summary><div class="indented"><div><p style="padding:0.2em"><b>Block text</b>: <mark class="highlight-yellow_background">(out + 1) % BUFFER_SIZE</mark></p><ul class="toggle"><li><div><span class="user" style="padding:0.2em"><img src="https://lh3.googleusercontent.com/a/ALm5wu2D7opyGPhg1IC5ZBqM5ZYIOR8MwAIakj3yS20lKw=s100" class="icon user-icon"/><span><b>roman hudaj</b> <time style="font-size:0.8em">Feb 28, 2024, 3:38 PM</time></span></span></div><div style="padding:0.2em">circular queue</div><div style="padding:0.3em"></div></li></ul></div><hr/></div></details></span></body></html>